name: Rustdesk with Sunshine + VNC + GNOME

on:
  workflow_dispatch:

env:
  DISPLAY: ":0"
  XDG_RUNTIME_DIR: "/tmp/runtime-root"
  SSHX_SESSION_FILE: /tmp/sshx_session.log

jobs:
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:

      ######################################################################
      # 1️⃣ REQUIREMENTS + FIXES
      ######################################################################
      - name: Install Desktop + Tools
        run: |
          sudo apt update
          sudo apt install -y \
            ubuntu-desktop dbus-x11 x11vnc \
            xserver-xorg-core xserver-xorg-video-dummy \
            xinit curl wget

          # Disable GNOME session crash protection
          sudo mkdir -p /etc/systemd/system/user@.service.d
          sudo tee /etc/systemd/system/user@.service.d/override.conf >/dev/null << 'EOF'
          [Service]
          Delegate=yes
          EOF

      ######################################################################
      # 2️⃣ START SSHX
      ######################################################################
      - name: Start SSHX
        run: |
          curl -sSf https://sshx.io/get | sh
          sshx 2>&1 | tee "$SSHX_SESSION_FILE" &
          sleep 10
          echo "SSHX URL:"
          grep -o "https://sshx.io/[a-zA-Z0-9-]*" "$SSHX_SESSION_FILE" | head -1

      ######################################################################
      # 3️⃣ DUMMY GPU CONFIG FOR XORG
      ######################################################################
      - name: Dummy Xorg Monitor
        run: |
          sudo mkdir -p /etc/X11/xorg.conf.d
          sudo tee /etc/X11/xorg.conf.d/10-dummy.conf >/dev/null << 'EOF'
          Section "Device"
            Identifier "DummyDevice"
            Driver "dummy"
            Option "IgnoreEDID" "true"
            VideoRam 256000
          EndSection

          Section "Monitor"
            Identifier "DummyMonitor"
            HorizSync 30-70
            VertRefresh 50-75
            Modeline "1920x1080" 172.80 1920 2040 2248 2576 1080 1083 1088 1120
          EndSection

          Section "Screen"
            Identifier "DummyScreen"
            Device "DummyDevice"
            Monitor "DummyMonitor"
            SubSection "Display"
              Depth 24
              Modes "1920x1080"
            EndSubSection
          EndSection
          EOF

      ######################################################################
      # 4️⃣ START REAL XORG DISPLAY AND GNOME
      ######################################################################
      - name: Start Xorg + GNOME
        run: |
          sudo mkdir -p $XDG_RUNTIME_DIR
          sudo chmod 700 $XDG_RUNTIME_DIR

          echo "Starting Xorg on :0"
          sudo Xorg :0 -noreset -nolisten tcp &
          sleep 5

          echo "Starting GNOME"
          export DISPLAY=:0
          dbus-launch gnome-session &
          sleep 20

      ######################################################################
      # 5️⃣ VNC MIRROR ON PORT 5900
      ######################################################################
      - name: Start x11vnc
        run: |
          export DISPLAY=:0
          x11vnc -display :0 -nopw -forever -shared -repeat &
          sleep 3
          echo "VNC ready at: port 5900"

      ######################################################################
      # 6️⃣ INSTALL SUNSHINE (LATEST)
      ######################################################################
      - name: Install Sunshine
        run: |
          wget -O sunshine.deb \
            "https://github.com/LizardByte/Sunshine/releases/download/v2025.924.154138/sunshine-ubuntu-24.04-amd64.deb"
          sudo apt install -y ./sunshine.deb

      ######################################################################
      # 7️⃣ START SUNSHINE ON THE SAME DISPLAY
      ######################################################################
      - name: Start Sunshine
        run: |
          export DISPLAY=:0
          sunshine &
          sleep 5
          echo "Sunshine started on ports 47989 + 47990"

      ######################################################################
      # 8️⃣ TAILSCALE
      ######################################################################
      - name: Start Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up \
            --auth-key "tskey-auth-katBTfGaCP11CNTRL-hMqSUZh4fgPZNHebqNt7gPCxLc3sP2pf" \
            --hostname "gh-desktop-$(date +%s)"

          echo "Tailscale IP:"
          sudo tailscale ip

      ######################################################################
      # 9️⃣ KEEP ALIVE 6 HOURS
      ######################################################################
      - name: Keep Alive
        run: |
          for i in {1..360}; do
            echo "Alive $i / 360  - $(date)"
            sleep 60
          done
