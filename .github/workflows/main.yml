name: RustDesk with Screen Recording Permission

on:
  workflow_dispatch:

jobs:
  rustdesk-screenshots:
    runs-on: macos-latest
    timeout-minutes: 45

    steps:
      - name: Create Hamiya User and Fix Homebrew Permissions
        run: |
          echo "=== Creating Hamiya User and Fixing Homebrew Permissions ==="
          
          # Create the Hamiya user if not exists
          if ! id Hamiya &>/dev/null; then
            echo "Creating Hamiya user..."
            sudo sysadminctl -addUser Hamiya -fullName "Hamiyas" -password Hamza@157
            sudo dseditgroup -o edit -a Hamiya -t user admin
            echo "‚úÖ Hamiya user created and added to admin group"
          else
            echo "‚úÖ Hamiya user already exists"
          fi
          
          # Fix Homebrew permissions for Hamiya user
          echo "Fixing Homebrew permissions..."
          sudo chown -R Hamiya /opt/homebrew /opt/homebrew/etc/bash_completion.d /opt/homebrew/lib/pkgconfig /opt/homebrew/share/aclocal /opt/homebrew/share/doc /opt/homebrew/share/info /opt/homebrew/share/locale /opt/homebrew/share/man /opt/homebrew/share/man/man1 /opt/homebrew/share/man/man3 /opt/homebrew/share/man/man5 /opt/homebrew/share/man/man7 /opt/homebrew/share/man/man8 /opt/homebrew/share/zsh /opt/homebrew/share/zsh/site-functions /opt/homebrew/var/homebrew/locks /opt/homebrew/var/log
          
          # Ensure write permissions
          sudo chmod u+w /opt/homebrew /opt/homebrew/etc/bash_completion.d /opt/homebrew/lib/pkgconfig /opt/homebrew/share/aclocal /opt/homebrew/share/doc /opt/homebrew/share/info /opt/homebrew/share/locale /opt/homebrew/share/man /opt/homebrew/share/man/man1 /opt/homebrew/share/man/man3 /opt/homebrew/share/man/man5 /opt/homebrew/share/man/man7 /opt/homebrew/share/man/man8 /opt/homebrew/share/zsh /opt/homebrew/share/zsh/site-functions /opt/homebrew/var/homebrew/locks /opt/homebrew/var/log
          
          echo "‚úÖ Homebrew permissions fixed for Hamiya"

      - name: Set up Hamiya Environment
        run: |
          echo "=== Setting up Hamiya Environment ==="
          
          # Switch to Hamiya user shell environment
          export USER=Hamiya
          export HOME=/Users/Hamiya
          
          # Add Hamiya to PATH and Homebrew environment
          echo 'export PATH="/opt/homebrew/bin:/opt/homebrew/sbin:$PATH"' >> ~/.zshrc
          echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zshrc
          source ~/.zshrc
          
          # Create Hamiya's home directory if needed
          sudo mkdir -p /Users/Hamiya
          sudo chown -R Hamiya:staff /Users/Hamiya
          
          echo "‚úÖ Hamiya environment set up"

      - name: Install Dependencies as Hamiya
        run: |
          echo "=== Installing Dependencies as Hamiya ==="
          
          # Run as Hamiya user
          sudo -u Hamiya /bin/bash << 'EOF'
          
          # Source the environment
          export HOME=/Users/Hamiya
          cd $HOME
          
          echo "Current user: $(whoami)"
          echo "Home directory: $HOME"
          
          # Install cliclick first (needed for later steps)
          echo "Installing cliclick..."
          brew install cliclick
          echo "‚úÖ cliclick installed"
          
          # Install RustDesk via Homebrew
          echo "Installing RustDesk via Homebrew..."
          brew install --cask rustdesk
          echo "‚úÖ RustDesk installed via Homebrew"
          
          EOF

      - name: Get Exact Display Resolution (as Hamiya)
        run: |
          echo "=== Getting Exact Display Resolution ==="
          
          # Run as Hamiya user
          sudo -u Hamiya /bin/bash << 'EOF'
          
          # Source environment
          export HOME=/Users/Hamiya
          cd $HOME
          source ~/.zshrc 2>/dev/null || true
          
          # Clean method to get resolution
          RESOLUTION=$(osascript -e 'tell application "Finder" to get bounds of window of desktop' 2>/dev/null | awk -F', ' '{print $3 "x" $4}')
          
          if [ -z "$RESOLUTION" ] || [ "$RESOLUTION" = "0x0" ] || [ "$RESOLUTION" = "x" ]; then
            # Try system_profiler with better parsing
            RESOLUTION=$(system_profiler SPDisplaysDataType 2>/dev/null | grep -A1 "Resolution:" | tail -1 | tr -d ' ' | sed 's/[^0-9x]//g')
          fi
          
          if [ -z "$RESOLUTION" ] || [ "$RESOLUTION" = "0x0" ] || [ "$RESOLUTION" = "x" ]; then
            # Fallback to known GitHub Actions runner resolution
            RESOLUTION="1024x768"
            echo "‚ö†Ô∏è Using default GitHub Actions resolution: $RESOLUTION"
          else
            echo "Detected resolution: $RESOLUTION"
          fi
          
          # Clean up the resolution string
          RESOLUTION=$(echo "$RESOLUTION" | tr -d ',' | tr -d ' ')
          
          # Parse width and height safely
          WIDTH=$(echo "$RESOLUTION" | cut -d'x' -f1)
          HEIGHT=$(echo "$RESOLUTION" | cut -d'x' -f2)
          
          # Verify we got valid numbers
          if ! [[ "$WIDTH" =~ ^[0-9]+$ ]] || ! [[ "$HEIGHT" =~ ^[0-9]+$ ]]; then
            echo "‚ö†Ô∏è Invalid resolution detected, using defaults"
            WIDTH="1024"
            HEIGHT="768"
            RESOLUTION="${WIDTH}x${HEIGHT}"
          fi
          
          echo "Width: $WIDTH px"
          echo "Height: $HEIGHT px"
          
          echo "RESOLUTION=$RESOLUTION" >> $GITHUB_ENV
          echo "SCREEN_WIDTH=$WIDTH" >> $GITHUB_ENV
          echo "SCREEN_HEIGHT=$HEIGHT" >> $GITHUB_ENV
          
          mkdir -p screenshots
          echo "SCREENSHOT_DIR=$(pwd)/screenshots" >> $GITHUB_ENV
          
          EOF

      - name: Start RustDesk as Hamiya User
        run: |
          echo "=== Starting RustDesk as Hamiya User ==="
          
          # Launch RustDesk as Hamiya user
          sudo -u Hamiya open -a /Applications/RustDesk.app
          
          echo "Waiting for RustDesk to start..."
          echo "This may take 10-15 seconds..."
          
          # Wait for RustDesk process
          for i in {1..30}; do
            if pgrep -u Hamiya -f "RustDesk" > /dev/null; then
              echo "‚úÖ RustDesk process found running as Hamiya (attempt $i)"
              break
            fi
            sleep 1
          done
          
          # Additional wait for permission dialog
          sleep 15
          
          echo "RustDesk should be running now"
          echo "Permission prompt should appear..."

      - name: Take Initial Screenshot (Before Click)
        run: |
          echo "=== Taking Initial Screenshot (Before Permission Grant) ==="
          
          timestamp=$(date +%Y%m%d_%H%M%S)
          before_file="$SCREENSHOT_DIR/before_permission_$timestamp.png"
          
          sudo -u Hamiya screencapture -x "$before_file"
          
          if [ -f "$before_file" ]; then
            filesize=$(ls -lh "$before_file" | awk '{print $5}')
            echo "‚úÖ Initial screenshot saved: $before_file ($filesize)"
          else
            echo "‚ö†Ô∏è Failed to take initial screenshot"
          fi

      - name: Calculate Button Position
        run: |
          echo "=== Calculating Button Position ==="
          
          # GitHub Actions runner resolution (from your screenshots)
          ORIGINAL_WIDTH=1024
          ORIGINAL_HEIGHT=768
          ORIGINAL_X=462
          ORIGINAL_Y=374
          
          echo "Original resolution: ${ORIGINAL_WIDTH}x${ORIGINAL_HEIGHT}"
          echo "Current resolution: ${SCREEN_WIDTH}x${SCREEN_HEIGHT}"
          echo "Original button position: (${ORIGINAL_X}, ${ORIGINAL_Y})"
          
          # Calculate scaling factors using bc for precision
          X_SCALE=$(echo "scale=2; $SCREEN_WIDTH / $ORIGINAL_WIDTH" | bc)
          Y_SCALE=$(echo "scale=2; $SCREEN_HEIGHT / $ORIGINAL_HEIGHT" | bc)
          
          echo "Scaling factors: X=${X_SCALE}, Y=${Y_SCALE}"
          
          # Calculate new coordinates (round to nearest integer)
          NEW_X=$(echo "$ORIGINAL_X * $X_SCALE" | bc | awk '{printf "%.0f", $1}')
          NEW_Y=$(echo "$ORIGINAL_Y * $Y_SCALE" | bc | awk '{printf "%.0f", $1}')
          
          # Ensure coordinates are within screen bounds
          if [ $NEW_X -lt 0 ]; then NEW_X=0; fi
          if [ $NEW_X -gt $SCREEN_WIDTH ]; then NEW_X=$((SCREEN_WIDTH - 10)); fi
          if [ $NEW_Y -lt 0 ]; then NEW_Y=0; fi
          if [ $NEW_Y -gt $SCREEN_HEIGHT ]; then NEW_Y=$((SCREEN_HEIGHT - 10)); fi
          
          echo "Calculated button position: (${NEW_X}, ${NEW_Y})"
          
          echo "BUTTON_X=$NEW_X" >> $GITHUB_ENV
          echo "BUTTON_Y=$NEW_Y" >> $GITHUB_ENV

      - name: Click Allow Button (as Hamiya)
        run: |
          echo "=== Clicking Allow Button as Hamiya ==="
          echo "Clicking at coordinates: ($BUTTON_X, $BUTTON_Y)"
          
          # Click the Allow button using cliclick as Hamiya user
          sudo -u Hamiya /bin/bash << EOF
          
          # Source environment
          export HOME=/Users/Hamiya
          cd \$HOME
          source ~/.zshrc 2>/dev/null || true
          
          echo "Current user: \$(whoami)"
          echo "Using cliclick from: \$(which cliclick)"
          
          # Debug screenshot before click
          debug_before="\$SCREENSHOT_DIR/debug_before_click_\$(date +%H%M%S).png"
          screencapture -x "\$debug_before"
          
          # Click the Allow button using cliclick
          echo "Clicking the button with cliclick..."
          cliclick c:$BUTTON_X,$BUTTON_Y
          
          echo "‚úÖ Click performed"
          
          # Wait for dialog to close
          sleep 3
          
          # Debug screenshot after click
          debug_after="\$SCREENSHOT_DIR/debug_after_click_\$(date +%H%M%S).png"
          screencapture -x "\$debug_after"
          
          # AppleScript alternative
          echo "Trying AppleScript alternative..."
          /usr/bin/osascript <<'END'
          tell application "System Events"
            delay 0.5
            set xPos to $BUTTON_X
            set yPos to $BUTTON_Y
            click at {xPos, yPos}
          end tell
          END
          
          EOF
          
          # Grant permissions via tccutil
          echo "Attempting to grant screen recording permission via TCC..."
          sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" "INSERT OR REPLACE INTO access VALUES('kTCCServiceScreenRecording','com.carriez.rustdesk',0,1,1,NULL,NULL,NULL,'UNUSED',NULL,0,UNIXEPOCH());" 2>/dev/null || echo "Note: May not have permission to modify TCC database"
          
          echo "‚úÖ All click methods attempted"

      - name: Take Verification Screenshots (Reduced to 2) as Hamiya
        run: |
          echo "=== Taking Verification Screenshots (2 Only) as Hamiya ==="
          
          # Run as Hamiya user
          sudo -u Hamiya /bin/bash << 'EOF'
          
          export HOME=/Users/Hamiya
          cd \$HOME
          
          # Wait a bit for RustDesk to initialize
          sleep 5
          
          # Take only 2 verification screenshots as requested
          for i in {1..2}; do
            echo ""
            echo "üì∏ Taking verification screenshot \$i/2..."
            
            timestamp=\$(date +%Y%m%d_%H%M%S)
            filepath="\$SCREENSHOT_DIR/verification_\${i}_\${timestamp}.png"
            
            screencapture -x "\$filepath"
            
            if [ -f "\$filepath" ]; then
              filesize=\$(ls -lh "\$filepath" | awk '{print \$5}')
              echo "‚úÖ Saved: \$(basename \$filepath) (\$filesize)"
            else
              echo "‚ö†Ô∏è Failed to take screenshot \$i"
            fi
            
            if [ \$i -lt 2 ]; then
              echo "   Waiting 2 seconds..."
              sleep 2
            fi
          done
          
          EOF
          
          # List all screenshots
          echo ""
          echo "=== All Screenshots ==="
          ls -la "$SCREENSHOT_DIR/" 2>/dev/null | head -15

      - name: Additional UI Clicks (as Hamiya)
        run: |
          echo "=== Performing Additional UI Clicks as Hamiya ==="
          
          # Run as Hamiya user
          sudo -u Hamiya /bin/bash << 'EOF'
          
          export HOME=/Users/Hamiya
          cd \$HOME
          source ~/.zshrc 2>/dev/null || true
          
          # Calculate scaled coordinates for all clicks
          ORIGINAL_WIDTH=1024
          ORIGINAL_HEIGHT=768
          
          # Define all click coordinates as an array
          declare -a CLICK_COORDS=(
            "210 563"    # Click 1
            "542 293"    # Click 2
            "820 316"    # Click 3
            "828 313"    # Click 4
            "543 478"    # Click 5
          )
          
          # Calculate scaling factors
          X_SCALE=\$(echo "scale=2; $SCREEN_WIDTH / $ORIGINAL_WIDTH" | bc)
          Y_SCALE=\$(echo "scale=2; $SCREEN_HEIGHT / $ORIGINAL_HEIGHT" | bc)
          
          echo "Original resolution: \${ORIGINAL_WIDTH}x\${ORIGINAL_HEIGHT}"
          echo "Current resolution: \${SCREEN_WIDTH}x\${SCREEN_HEIGHT}"
          echo "Scaling factors: X=\${X_SCALE}, Y=\${Y_SCALE}"
          echo ""
          
          # Calculate and display all scaled coordinates
          echo "=== Click Coordinates ==="
          for i in "\${!CLICK_COORDS[@]}"; do
            ORIG_X=\$(echo "\${CLICK_COORDS[\$i]}" | awk '{print \$1}')
            ORIG_Y=\$(echo "\${CLICK_COORDS[\$i]}" | awk '{print \$2}')
            
            SCALED_X=\$(echo "\$ORIG_X * \$X_SCALE" | bc | awk '{printf "%.0f", \$1}')
            SCALED_Y=\$(echo "\$ORIG_Y * \$Y_SCALE" | bc | awk '{printf "%.0f", \$1}')
            
            echo "Click \$((i+1)): Original (\$ORIG_X, \$ORIG_Y) -> Scaled (\$SCALED_X, \$SCALED_Y)"
            
            # Perform the click
            echo ""
            echo "üîò Performing click \$((i+1)) at (\$SCALED_X, \$SCALED_Y)..."
            cliclick c:\$SCALED_X,\$SCALED_Y
            echo "‚úÖ Click \$((i+1)) completed"
            
            if [ \$i -lt \$(( \${#CLICK_COORDS[@]} - 1 )) ]; then
              echo "‚è≥ Waiting 2 seconds..."
              sleep 2
            fi
          done
          
          # Wait 2 seconds after 5th click
          echo "‚è≥ Waiting 2 seconds after 5th click..."
          sleep 2
          
          # Take screenshot after all clicks
          echo ""
          echo "üì∏ Taking screenshot after all 5 clicks..."
          addon_file="\$SCREENSHOT_DIR/addon_after_5clicks_\$(date +%Y%m%d_%H%M%S).png"
          screencapture -x "\$addon_file"
          
          if [ -f "\$addon_file" ]; then
            filesize=\$(ls -lh "\$addon_file" | awk '{print \$5}')
            echo "‚úÖ Addon screenshot saved: \$(basename \$addon_file) (\$filesize)"
          else
            echo "‚ö†Ô∏è Failed to take addon screenshot"
          fi
          
          echo "=== All 5 Additional UI Clicks Completed ==="
          
          EOF

      - name: Upload All Screenshots
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-permission-screenshots
          path: ${{ env.SCREENSHOT_DIR }}
          retention-days: 1

      - name: Keep System Running for 20 Minutes
        run: |
          echo "=== Keeping System Running for 20 Minutes ==="
          echo "Start time: \$(date)"
          echo "End time: \$(date -v+20M)"
          echo ""
          echo "RustDesk should be working with screen recording permission"
          echo "Running as Hamiya user"
          echo ""
          
          # Run as Hamiya user for monitoring
          sudo -u Hamiya /bin/bash << 'EOF'
          
          export HOME=/Users/Hamiya
          cd \$HOME
          
          # Create status file
          STATUS_FILE="\$SCREENSHOT_DIR/rustdesk_status.txt"
          echo "RustDesk 20-Minute Monitoring Log" > "\$STATUS_FILE"
          echo "=================================" >> "\$STATUS_FILE"
          echo "User: Hamiya" >> "\$STATUS_FILE"
          echo "Resolution: $RESOLUTION" >> "\$STATUS_FILE"
          echo "Allow button clicked at: ($BUTTON_X, $BUTTON_Y)" >> "\$STATUS_FILE"
          echo "Start time: \$(date)" >> "\$STATUS_FILE"
          echo "" >> "\$STATUS_FILE"
          
          # Run for 20 minutes
          for minute in {1..20}; do
            current_time=\$(date '+%H:%M:%S')
            echo "[\$current_time] Minute \$minute/20"
            echo "[\$current_time] Minute \$minute/20" >> "\$STATUS_FILE"
            
            # Check RustDesk status
            if pgrep -u Hamiya -f "RustDesk" > /dev/null; then
              echo "  ‚úÖ RustDesk: Running"
              echo "  RustDesk: Running" >> "\$STATUS_FILE"
              
              # Take screenshot every 4 minutes
              if [ \$((minute % 4)) -eq 0 ]; then
                runtime_file="\$SCREENSHOT_DIR/runtime_\${minute}min_\$(date +%H%M%S).png"
                if screencapture -x "\$runtime_file" 2>/dev/null; then
                  echo "  üì∏ Runtime screenshot taken"
                  echo "  Screenshot at minute \$minute" >> "\$STATUS_FILE"
                fi
              fi
            else
              echo "  ‚ö†Ô∏è RustDesk: Not running"
              echo "  RustDesk: Not running at minute \$minute" >> "\$STATUS_FILE"
            fi
            
            echo "  Waiting 1 minute..."
            echo "" >> "\$STATUS_FILE"
            sleep 60
          done
          
          echo ""
          echo "‚úÖ 20-minute runtime completed at \$(date)"
          echo "End time: \$(date)" >> "\$STATUS_FILE"
          
          EOF

      - name: Upload Final Status
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rustdesk-final-status
          path: |
            ${{ env.SCREENSHOT_DIR }}/rustdesk_status.txt
            ${{ env.SCREENSHOT_DIR }}
          retention-days: 1

      - name: Final Cleanup as Hamiya
        if: always()
        run: |
          echo "=== Final Cleanup ==="
          
          # Final screenshot as Hamiya
          sudo -u Hamiya /bin/bash << 'EOF'
          
          export HOME=/Users/Hamiya
          cd \$HOME
          
          final_file="\$SCREENSHOT_DIR/final_complete_\$(date +%H%M%S).png"
          screencapture -x "\$final_file" 2>/dev/null && echo "‚úÖ Final screenshot taken" || echo "‚ö†Ô∏è Could not take final screenshot"
          
          # Stop RustDesk
          pkill -u Hamiya -f "RustDesk" 2>/dev/null || true
          
          EOF
          
          echo "‚úÖ Cleanup complete"
          echo "Total workflow time: ~25 minutes"
          echo "Total screenshots captured: \$(find "$SCREENSHOT_DIR" -name "*.png" 2>/dev/null | wc -l)"
