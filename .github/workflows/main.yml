name: Run sshx.io

on:
  workflow_dispatch:

jobs:
  run-sshx:
    runs-on: macos-latest
    timeout-minutes: 15

    steps:
      - name: Install and run sshx
        run: |
          echo "=== Installing and running sshx ==="
          
          # Install sshx
          curl -sSf https://sshx.io/get | sh
          
          # Wait a moment for installation to complete
          sleep 2
          
          # Now run sshx to get the URL
          echo "=== Starting sshx session ==="
          
          # Run sshx in background and capture output
          # The -t flag creates a persistent tunnel
          sshx -t &
          SSHX_PID=$!
          
          # Give sshx time to start and generate URL
          sleep 5
          
          # Try to get URL (sshx might print it to stderr or stdout)
          echo "=== Attempting to get sshx URL ==="
          
          # Check if sshx process is running
          if ps -p $SSHX_PID > /dev/null; then
            echo "✅ sshx is running with PID: $SSHX_PID"
            
            # sshx usually prints URL to stderr when run with -t
            # We'll try to capture recent logs
            echo "Checking for sshx URL in logs..."
            
            # Run sshx in a way that might show the URL
            timeout 3 sshx -t 2>&1 | grep -i "sshx://" || echo "URL not found in output"
            
          else
            echo "❌ sshx failed to start"
          fi
          
      - name: Keep session alive
        run: |
          echo "=== Keeping sshx session alive for 10 minutes ==="
          # Keep the workflow running so sshx stays active
          sleep 600
          echo "10 minutes have passed"
