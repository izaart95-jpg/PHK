name: Rustdesk with Sunshine

on:
  workflow_dispatch:

env:
  SSHX_SESSION_FILE: /tmp/sshx_session.log
  SSHX_PID: 0

jobs:
  setup-sshx:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours total

    steps:
      - name: Install dependencies
        run: |
          echo "=== Installing basic dependencies ==="
          sudo apt-get update
          sudo apt-get install -y curl wget
          echo "âœ… Dependencies installed"

      - name: Install sshx and show URL
        run: |
          echo "=== Installing sshx ==="
          curl -sSf https://sshx.io/get | sh
          
          echo ""
          echo "=== Starting sshx session ==="
          
          # Run sshx and capture output to file
          sshx 2>&1 | tee "$SSHX_SESSION_FILE" &
          SSHX_PID=$!
          echo "SSHX_PID=$SSHX_PID" >> $GITHUB_ENV
          
          # Wait for sshx to start
          sleep 10
          
          # Check if sshx is running
          if ps -p $SSHX_PID > /dev/null 2>&1; then
            echo "âœ… sshx running with PID: $SSHX_PID"
          else
            echo "âš ï¸ sshx may have exited"
          fi
          
          # Extract and show the sshx URL
          echo ""
          echo "=== SSHX Connection URL ==="
          if [ -f "$SSHX_SESSION_FILE" ]; then
            # Look for the sshx.io URL in the output
            SSHX_URL=$(grep -o "https://sshx.io/[a-zA-Z0-9-]\+" "$SSHX_SESSION_FILE" | head -1 || true)
            if [ ! -z "$SSHX_URL" ]; then
              echo "ğŸ”— Connect via: $SSHX_URL"
              echo "SSHX_URL=$SSHX_URL" >> $GITHUB_ENV
            else
              echo "âš ï¸ Could not extract SSHX URL from logs"
              echo "=== Last 10 lines of sshx output ==="
              tail -10 "$SSHX_SESSION_FILE" || true
            fi
          fi

      - name: Install Ubuntu Desktop and VNC
        run: |
          echo "=== Installing Ubuntu Desktop and VNC ==="
          
          # Install required packages
          sudo apt-get update
          sudo apt-get install -y \
            ubuntu-desktop \
            tigervnc-standalone-server \
            dbus-x11 \
            xserver-xorg-video-dummy \
            xserver-xorg-input-void \
            xserver-xorg-core \
            xinit \
            openbox
            
          echo "âœ… Ubuntu Desktop and VNC installed"

      - name: Create dummy display configuration
        run: |
          echo "=== Creating dummy display configuration ==="
          
          # Create Xorg configuration directory
          sudo mkdir -p /etc/X11/xorg.conf.d
          
          # Create dummy display configuration
          sudo tee /etc/X11/xorg.conf.d/10-headless-monitor.conf > /dev/null << 'EOF'
Section "Device"
  Identifier "DummyDevice"
  Driver "dummy"
  Option "IgnoreEDID" "true"
  VideoRam 256000
EndSection

Section "Monitor"
  Identifier "DummyMonitor"
  HorizSync 30-70
  VertRefresh 50-75
  Modeline "1920x1080" 172.80 1920 2040 2248 2576 1080 1083 1088 1120
EndSection

Section "Screen"
  Identifier "DummyScreen"
  Device "DummyDevice"
  Monitor "DummyMonitor"
  DefaultDepth 24
  SubSection "Display"
    Depth 24
    Modes "1920x1080"
  EndSubSection
EndSection

Section "ServerLayout"
  Identifier "DefaultLayout"
  Screen "DummyScreen"
  InputDevice "VoidMouse"
  InputDevice "VoidKeyboard"
EndSection

Section "InputDevice"
  Identifier "VoidMouse"
  Driver "void"
  Option "Device" "/dev/null"
EndSection

Section "InputDevice"
  Identifier "VoidKeyboard"
  Driver "void"
  Option "Device" "/dev/null"
EndSection
EOF
          
          echo "âœ… Dummy display configuration created"

      - name: Install Tailscale
        run: |
          echo "=== Installing Tailscale ==="
          
          # Install Tailscale
          curl -fsSL https://tailscale.com/install.sh | sh
          
          # Start Tailscale with auth key
          sudo tailscale up --auth-key "tskey-auth-katBTfGaCP11CNTRL-hMqSUZh4fgPZNHebqNt7gPCxLc3sP2pf" --hostname "github-runner-$(date +%s)" &
          
          echo "âœ… Tailscale installed and connecting in background"
          
          # Wait a bit for connection
          sleep 15
          
          # Show Tailscale status
          echo "=== Tailscale Status ==="
          sudo tailscale status || true

      - name: Install Sunshine
        run: |
          echo "=== Installing Sunshine ==="
          
          # Download Sunshine
          SUNSHINE_URL="https://github.com/LizardByte/Sunshine/releases/download/v2025.924.154138/sunshine-ubuntu-24.04-amd64.deb"
          SUNSHINE_DEB="sunshine.deb"
          
          echo "Downloading Sunshine from: $SUNSHINE_URL"
          wget -O "$SUNSHINE_DEB" "$SUNSHINE_URL"
          
          echo "Installing Sunshine..."
          sudo apt install -y "./$SUNSHINE_DEB"
          
          # Install software encoder dependencies
          sudo apt-get install -y \
            libavcodec-extra \
            libva-dev \
            libvdpau-dev \
            libx264-dev \
            libx265-dev \
            libvpx-dev \
            libfdk-aac-dev
            
          echo "âœ… Sunshine installed"

      - name: Start Xorg and Sunshine
        run: |
          echo "=== Starting Xorg Display Server ==="
          
          # Set display environment variable
          export DISPLAY=:0
          echo "DISPLAY=$DISPLAY" >> $GITHUB_ENV
          
          # Start Xorg with dummy driver on display :0
          sudo Xorg :0 -config /etc/X11/xorg.conf.d/10-headless-monitor.conf -sharevts -noreset &
          XORG_PID=$!
          echo "XORG_PID=$XORG_PID" >> $GITHUB_ENV
          
          # Wait for Xorg to start
          sleep 5
          
          # Check if Xorg is running
          if ps -p $XORG_PID > /dev/null 2>&1; then
            echo "âœ… Xorg running on display :0 (PID: $XORG_PID)"
          else
            echo "âŒ Xorg failed to start"
            exit 1
          fi
          
          # Start a simple window manager (Openbox)
          export DISPLAY=:0
          openbox &
          OPENBOX_PID=$!
          echo "OPENBOX_PID=$OPENBOX_PID" >> $GITHUB_ENV
          
          # Start Sunshine with proper environment
          echo "=== Starting Sunshine ==="
          export DISPLAY=:0
          export WAYLAND_DISPLAY=wayland-0  # Set WAYLAND_DISPLAY to prevent the error
          sunshine &
          SUNSHINE_PID=$!
          echo "SUNSHINE_PID=$SUNSHINE_PID" >> $GITHUB_ENV
          
          # Wait for Sunshine to start
          sleep 10
          
          # Create initial credentials if needed
          if [ ! -f /home/runner/.config/sunshine/sunshine_state.json ]; then
            echo "=== Setting up Sunshine credentials ==="
            # Sunshine should prompt for credentials on first web UI access
            echo "Please access the web UI to set up credentials:"
            echo "  - http://localhost:47990"
            echo "  - Default username/password: sunshine/sunshine"
          fi
          
          echo "âœ… Sunshine started with PID: $SUNSHINE_PID"
          echo "ğŸŒ Web interface: http://localhost:47990"
          echo "ğŸŒ Streaming port: 47989"
          echo "ğŸŒ Display: :0"
          echo "ğŸŒ Using software encoder"

      - name: Keep SSHX alive for 6 hours
        run: |
          echo "=== SSHX Remote Access Active ==="
          echo ""
          echo "Start time: $(date)"
          echo "Will keep alive until: $(date -d '+6 hours')"
          echo ""
          
          # Display SSHX connection info
          if [ -f "$SSHX_SESSION_FILE" ]; then
            echo "=== SSHX Session Information ==="
            SSHX_URL=$(grep -o "https://sshx.io/[a-zA-Z0-9-]\+" "$SSHX_SESSION_FILE" | head -1 || true)
            if [ ! -z "$SSHX_URL" ]; then
              echo "ğŸ”— SSHX Connection URL: $SSHX_URL"
            else
              echo "âš ï¸ SSHX URL not found in logs"
            fi
            echo ""
          fi
          
          # Display Tailscale IP if connected
          echo "=== Tailscale Status ==="
          sudo tailscale ip 2>/dev/null | head -1 | while read ip; do
            echo "ğŸŒ Tailscale IP: $ip"
          done || echo "Tailscale IP not available"
          echo ""
          
          # Display Sunshine info
          echo "=== Sunshine Information ==="
          echo "ğŸŒ Sunshine Web Interface: http://localhost:47990"
          echo "ğŸŒ Sunshine via Tailscale: http://<tailscale-ip>:47990"
          echo "ğŸŒ Streaming Port: 47989"
          echo "ğŸŒ Display: :0"
          echo "ğŸŒ Using software encoder (CPU-based)"
          echo ""
          
          # Keep alive for 6 hours (360 minutes)
          TOTAL_MINUTES=360
          for minute in $(seq 1 $TOTAL_MINUTES); do
            echo "=== Minute $minute/$TOTAL_MINUTES ==="
            echo "Time: $(date)"
            echo "Elapsed: $((minute / 60))h $((minute % 60))m"
            echo "Remaining: $(((TOTAL_MINUTES - minute) / 60))h $(((TOTAL_MINUTES - minute) % 60))m"
            
            # Check if sshx is running
            if [ ! -z "$SSHX_PID" ] && ps -p $SSHX_PID > /dev/null 2>&1; then
              echo "âœ… sshx: Running (PID: $SSHX_PID)"
            else
              echo "âŒ sshx: Not running, attempting to restart..."
              # Kill any remaining sshx processes
              pkill -f "sshx" 2>/dev/null || true
              sleep 2
              # Restart sshx
              sshx 2>&1 | tee -a "$SSHX_SESSION_FILE" &
              SSHX_PID=$!
              echo "New PID: $SSHX_PID"
              echo "SSHX_PID=$SSHX_PID" >> $GITHUB_ENV
              sleep 10
            fi
            
            # Check other services every 5 minutes
            if [ $((minute % 5)) -eq 0 ]; then
              echo "=== Service Status Check ==="
              
              # Check Xorg
              if [ ! -z "$XORG_PID" ] && ps -p $XORG_PID > /dev/null 2>&1; then
                echo "âœ… Xorg: Running (PID: $XORG_PID)"
                echo "   Display: :0"
              else
                echo "âš ï¸ Xorg: Not running, attempting restart..."
                # Restart Xorg
                sudo Xorg :0 -config /etc/X11/xorg.conf.d/10-headless-monitor.conf -sharevts -noreset &
                XORG_PID=$!
                echo "XORG_PID=$XORG_PID" >> $GITHUB_ENV
                sleep 5
              fi
              
              # Check Tailscale
              if sudo tailscale status 2>/dev/null | grep -q "active"; then
                echo "âœ… Tailscale: Connected"
                # Show Tailscale IP
                TAILSCALE_IP=$(sudo tailscale ip 2>/dev/null | head -1 || echo "")
                if [ ! -z "$TAILSCALE_IP" ]; then
                  echo "   IP Address: $TAILSCALE_IP"
                  echo "   Sunshine via Tailscale: http://$TAILSCALE_IP:47990"
                fi
              else
                echo "âš ï¸ Tailscale: Not connected, attempting restart..."
                sudo tailscale up --auth-key "tskey-auth-katBTfGaCP11CNTRL-hMqSUZh4fgPZNHebqNt7gPCxLc3sP2pf" --reset || true
              fi
              
              # Check Sunshine
              if [ ! -z "$SUNSHINE_PID" ] && ps -p $SUNSHINE_PID > /dev/null 2>&1; then
                echo "âœ… Sunshine: Running (PID: $SUNSHINE_PID)"
                echo "   Web Interface: http://localhost:47990"
                echo "   Streaming: port 47989"
              else
                echo "âš ï¸ Sunshine: Not running, attempting restart..."
                # Kill any remaining sunshine processes
                pkill -f "sunshine" 2>/dev/null || true
                sleep 2
                # Restart Sunshine
                export DISPLAY=:0
                export WAYLAND_DISPLAY=wayland-0
                sunshine &
                SUNSHINE_PID=$!
                echo "SUNSHINE_PID=$SUNSHINE_PID" >> $GITHUB_ENV
                sleep 10
              fi
            fi
            
            # Wait for next minute
            if [ $minute -lt $TOTAL_MINUTES ]; then
              echo "â³ Waiting 60 seconds..."
              sleep 60
            fi
          done
          
          echo ""
          echo "âœ… 6 hours complete. Session ending."

      - name: Cleanup
        if: always()
        run: |
          echo "=== Cleaning up ==="
          
          # Kill sshx process
          if [ ! -z "$SSHX_PID" ] && ps -p $SSHX_PID > /dev/null 2>&1; then
            echo "Stopping sshx (PID: $SSHX_PID)..."
            kill $SSHX_PID 2>/dev/null || true
            sleep 2
          fi
          
          # Kill any other sshx processes
          pkill -f "sshx" 2>/dev/null || true
          
          # Kill Sunshine
          echo "Stopping Sunshine..."
          pkill -f "sunshine" 2>/dev/null || true
          
          # Kill Xorg
          echo "Stopping Xorg..."
          pkill -f "Xorg" 2>/dev/null || true
          
          # Stop Tailscale
          echo "Stopping Tailscale..."
          sudo tailscale down 2>/dev/null || true
          
          echo "âœ… Cleanup complete"
