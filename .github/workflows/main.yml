name: SSHX Remote Access with Screenshots

on:
  workflow_dispatch:

jobs:
  setup-sshx:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install required packages
        run: |
          echo "=== Installing required packages ==="
          sudo apt-get update
          sudo apt-get install -y curl ubuntu-desktop tigervnc-standalone-server dbus-x11
          echo "âœ… Packages installed"

      - name: Install Tailscale
        run: |
          echo "=== Installing Tailscale ==="
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --auth-key tskey-auth-katBTfGaCP11CNTRL-hMqSUZh4fgPZNHebqNt7gPCxLc3sP2pf
          echo "âœ… Tailscale installed and connected"

      - name: Install sshx
        run: |
          echo "=== Installing sshx ==="
          curl -sSf https://sshx.io/get | sh
          echo "âœ… sshx installed"

      - name: Install Sunshine
        run: |
          echo "=== Installing Sunshine ==="
          sudo apt install -y curl
          curl -fsSL https://get.sunshine.ninja | bash
          sudo systemctl enable sunshine
          sudo systemctl start sunshine
          echo "âœ… Sunshine installed"

      - name: Run sshx and display URL
        id: sshx_session
        run: |
          echo "=== Starting sshx session ==="
          SSHX_SESSION_FILE="$HOME/sshx_session.log"
          
          # Run sshx in background and capture output
          nohup sshx > "$SSHX_SESSION_FILE" 2>&1 &
          SSHX_PID=$!
          echo "SSHX_PID=$SSHX_PID" >> $GITHUB_ENV
          
          # Wait for sshx to start
          sleep 10
          
          # Extract and display URL
          if [ -f "$SSHX_SESSION_FILE" ]; then
            SSHX_URL=$(grep -o "https://[^ ]*\.sshx\.io" "$SSHX_SESSION_FILE" | head -1)
            if [ -n "$SSHX_URL" ]; then
              echo "SSHX_URL=$SSHX_URL" >> $GITHUB_ENV
              echo "âœ… SSHX Session URL: $SSHX_URL"
              echo "::notice title=SSHX Remote Access::Connect via: $SSHX_URL"
            else
              echo "âš ï¸ Could not extract SSHX URL from log"
              echo "=== Log content ==="
              cat "$SSHX_SESSION_FILE"
            fi
          fi
          
          # Keep sshx running in background
          echo "SSHX will continue running for 6 hours"

      - name: Keep alive for 6 hours
        run: |
          echo "=== SSHX Remote Access Active ==="
          echo ""
          echo "Start time: $(date)"
          echo "Will keep alive until: $(date -d '+6 hours')"
          echo ""
          
          if [ -n "$SSHX_URL" ]; then
            echo "ðŸ”— SSHX Connection URL: $SSHX_URL"
          fi
          
          echo "Tailscale Status:"
          sudo tailscale status
          echo ""
          
          echo "Sunshine Status:"
          sudo systemctl status sunshine --no-pager
          echo ""
          
          # Keep alive for 6 hours (360 minutes)
          for minute in {1..360}; do
            echo "=== Minute $minute/360 ==="
            echo "Time: $(date)"
            
            # Check if sshx is running
            if ps -p $SSHX_PID > /dev/null 2>&1; then
              echo "âœ… sshx: Running (PID: $SSHX_PID)"
              
              # Display URL every 10 minutes
              if [ $((minute % 10)) -eq 0 ] && [ -n "$SSHX_URL" ]; then
                echo "ðŸ”— SSHX URL: $SSHX_URL"
              fi
            else
              echo "âŒ sshx: Not running"
              break
            fi
            
            # Display status every 30 minutes
            if [ $((minute % 30)) -eq 0 ]; then
              echo "=== System Status ==="
              echo "Tailscale:"
              sudo tailscale status --json | jq -r '.Peer[] | select(.HostName | contains("github")) | "  \(.HostName): \(.TailscaleIPs[0])"' || true
              echo "Uptime: $(uptime -p)"
              echo "Memory: $(free -h | grep Mem | awk '{print $3"/"$2}')"
            fi
            
            # Wait for next minute
            if [ $minute -lt 360 ]; then
              remaining=$((360 - minute))
              hours=$((remaining / 60))
              minutes=$((remaining % 60))
              echo "â³ Remaining: ${hours}h ${minutes}m"
              sleep 60
            fi
          done
          
          echo ""
          echo "âœ… 6 hours complete."

      - name: Cleanup
        if: always()
        run: |
          echo "=== Cleaning up ==="
          
          # Kill sshx process
          if [ ! -z "$SSHX_PID" ] && ps -p $SSHX_PID > /dev/null 2>&1; then
            echo "Stopping sshx (PID: $SSHX_PID)..."
            kill $SSHX_PID 2>/dev/null || true
            sleep 2
          fi
          
          # Kill any other sshx processes
          pkill -f "sshx" 2>/dev/null || true
          
          # Disconnect Tailscale
          sudo tailscale down
          
          echo "âœ… Cleanup complete"
