name: SSHX Session

on:
  workflow_dispatch:

jobs:
  sshx-session:
    runs-on: macos-latest
    timeout-minutes: 360
    
    env:
      SSHX_SESSION_FILE: /tmp/sshx_output.txt

    steps:
      - name: Install sshx and show URL
        run: |
          echo "=== Installing sshx ==="
          curl -sSf https://sshx.io/get | sh
          
          echo ""
          echo "=== Starting sshx session ==="
          
          # Run sshx and capture output to file
          sshx 2>&1 | tee "$SSHX_SESSION_FILE" &
          SSHX_PID=$!
          
          # Wait for sshx to start
          sleep 10
          
          # Check if sshx is running
          if ps -p $SSHX_PID > /dev/null 2>&1; then
            echo "âœ… sshx running with PID: $SSHX_PID"
          else
            echo "âš ï¸ sshx may have exited"
          fi
          
          # Extract and show the sshx URL
          echo ""
          echo "=== SSHX Connection URL ==="
          if [ -f "$SSHX_SESSION_FILE" ]; then
            # Look for the sshx.io URL in the output
            SSHX_URL=$(grep -o "https://sshx.io/[a-zA-Z0-9_-]\+" "$SSHX_SESSION_FILE" | head -1 || true)
            if [ -n "$SSHX_URL" ]; then
              echo "ðŸ”— Connect via: $SSHX_URL"
              echo "SSHX_URL=$SSHX_URL" >> $GITHUB_ENV
            else
              echo "âš ï¸ Could not extract SSHX URL from logs"
              echo "Trying alternative patterns..."
              
              # Try different URL patterns
              SSHX_URL=$(grep -o "sshx://[a-zA-Z0-9._-]\+" "$SSHX_SESSION_FILE" | head -1 || true)
              if [ -n "$SSHX_URL" ]; then
                echo "ðŸ”— Connect via: $SSHX_URL"
                echo "SSHX_URL=$SSHX_URL" >> $GITHUB_ENV
              else
                SSHX_URL=$(grep -o "sshx.io/[a-zA-Z0-9_-]\+" "$SSHX_SESSION_FILE" | head -1 || true)
                if [ -n "$SSHX_URL" ]; then
                  echo "ðŸ”— Connect via: https://$SSHX_URL"
                  echo "SSHX_URL=https://$SSHX_URL" >> $GITHUB_ENV
                else
                  echo "âš ï¸ Still no URL found"
                  echo "=== Full sshx output ==="
                  cat "$SSHX_SESSION_FILE" || true
                fi
              fi
            fi
          fi
          
      - name: Keep session alive
        run: |
          echo "=== Keeping sshx session active ==="
          echo "Session will stay active for 10 minutes..."
          
          # Check if sshx is still running
          if [ -f "$SSHX_SESSION_FILE" ] && [ -n "$SSHX_PID" ] && ps -p $SSHX_PID > /dev/null 2>&1; then
            echo "âœ… sshx still running (PID: $SSHX_PID)"
            if [ -n "$SSHX_URL" ]; then
              echo "ðŸ”— Connection URL: $SSHX_URL"
            fi
          else
            echo "âš ï¸ sshx not running, starting new session..."
            sshx 2>&1 | tee "$SSHX_SESSION_FILE" &
            sleep 5
          fi
          
          # Keep workflow running
          echo "Waiting 6000 seconds..."
          sleep 21600
          echo "Session complete"
