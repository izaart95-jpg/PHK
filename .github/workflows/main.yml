name: SSHX Remote Access with Screenshots

on:
  workflow_dispatch:

jobs:
  setup-sshx:
    runs-on: ubuntu-latest
    timeout-minutes: 365  # 6 hours + buffer

    steps:
      - name: Install dependencies
        run: |
          echo "=== Installing system dependencies ==="
          sudo apt-get update
          sudo apt-get install -y curl ubuntu-desktop tigervnc-standalone-server dbus-x11
          echo "âœ… Dependencies installed"
      
      - name: Install Tailscale
        run: |
          echo "=== Installing Tailscale ==="
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --auth-key tskey-auth-katBTfGaCP11CNTRL-hMqSUZh4fgPZNHebqNt7gPCxLc3sP2pf &
          echo "âœ… Tailscale installed and connected"

      - name: Install Sunshine
        run: |
          echo "=== Installing Sunshine ==="
          curl -fsSL https://get.sunshine.ninja | bash
          sudo systemctl enable sunshine
          sudo systemctl start sunshine
          echo "âœ… Sunshine installed and started"

      - name: Install sshx
        run: |
          echo "=== Installing sshx ==="
          curl -sSf https://sshx.io/get | sh
          echo "âœ… sshx installed"

      - name: Start sshx and get URL
        run: |
          echo "=== Starting sshx session ==="
          SSHX_SESSION_FILE="/tmp/sshx_session_$(date +%s).log"
          echo "SSHX_SESSION_FILE=$SSHX_SESSION_FILE" >> $GITHUB_ENV
          
          # Run sshx and capture output
          sshx 2>&1 | tee "$SSHX_SESSION_FILE" &
          SSHX_PID=$!
          echo "SSHX_PID=$SSHX_PID" >> $GITHUB_ENV
          
          # Wait for sshx to initialize
          sleep 10
          
          # Extract and display the SSHX URL
          echo ""
          echo "=== SSHX Connection URL ==="
          if [ -f "$SSHX_SESSION_FILE" ]; then
            # Look for the URL in the output
            SSHX_URL=$(grep -i "connect\|join\|session\|http" "$SSHX_SESSION_FILE" | grep -o 'https://[^ ]*' | head -1)
            
            if [ -n "$SSHX_URL" ]; then
              echo "ðŸ”— SSHX URL: $SSHX_URL"
              echo "SSHX_URL=$SSHX_URL" >> $GITHUB_ENV
            else
              echo "âš ï¸ Could not extract SSHX URL from output. Check the session file:"
              cat "$SSHX_SESSION_FILE"
            fi
          fi
          
          # Keep sshx running
          echo "âœ… sshx running with PID: $SSHX_PID"

      - name: Keep alive for 6 hours
        run: |
          echo "=== SSHX Remote Access Active ==="
          echo ""
          echo "Start time: $(date)"
          echo "Will keep alive until: $(date -d '+6 hours')"
          echo ""
          
          # Display the SSHX URL
          if [ -n "$SSHX_URL" ]; then
            echo "ðŸ”— Connect using: $SSHX_URL"
          fi
          
          # Keep alive for 6 hours (360 minutes)
          for minute in {1..360}; do
            echo "=== Minute $minute/360 ==="
            echo "Time: $(date)"
            echo "Uptime: $((minute/60))h $((minute%60))m"
            
            # Check if sshx is running
            if ps -p $SSHX_PID > /dev/null 2>&1; then
              echo "âœ… sshx: Running (PID: $SSHX_PID)"
            else
              echo "âŒ sshx: Not running, attempting to restart..."
              # Kill any remaining sshx processes
              pkill -f "sshx" 2>/dev/null || true
              sleep 2
              # Restart sshx
              sshx 2>&1 | tee -a "$SSHX_SESSION_FILE" &
              SSHX_PID=$!
              echo "SSHX_PID=$SSHX_PID" >> $GITHUB_ENV
              echo "New PID: $SSHX_PID"
              sleep 10
              
              # Try to get new URL
              if [ -f "$SSHX_SESSION_FILE" ]; then
                SSHX_URL=$(grep -i "connect\|join\|session\|http" "$SSHX_SESSION_FILE" | grep -o 'https://[^ ]*' | tail -1)
                if [ -n "$SSHX_URL" ]; then
                  echo "ðŸ”— New SSHX URL: $SSHX_URL"
                  echo "SSHX_URL=$SSHX_URL" >> $GITHUB_ENV
                fi
              fi
            fi
            
            # Check Tailscale status
            if command -v tailscale &> /dev/null; then
              tailscale status --peers=false && echo "âœ… Tailscale: Connected" || echo "âš ï¸ Tailscale: Not connected"
            fi
            
            # Check Sunshine status
            if systemctl is-active --quiet sunshine; then
              echo "âœ… Sunshine: Running"
            else
              echo "âš ï¸ Sunshine: Not running"
            fi
            
            # Wait for next minute
            if [ $minute -lt 360 ]; then
              remaining=$((360 - minute))
              echo "â³ Remaining: $((remaining/60))h $((remaining%60))m"
              sleep 60
            fi
          done
          
          echo ""
          echo "âœ… 6 hours complete. Session ending."

      - name: Cleanup
        if: always()
        run: |
          echo "=== Cleaning up ==="
          
          # Kill sshx process
          if [ ! -z "$SSHX_PID" ] && ps -p $SSHX_PID > /dev/null 2>&1; then
            echo "Stopping sshx (PID: $SSHX_PID)..."
            kill $SSHX_PID 2>/dev/null || true
            sleep 2
          fi
          
          # Kill any other sshx processes
          pkill -f "sshx" 2>/dev/null || true
          
          echo "âœ… Cleanup complete"
