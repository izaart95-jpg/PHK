name: RustDesk MacOS Build Test

on:
  workflow_dispatch:

jobs:
  run_test:
    runs-on: macos-15

    steps:

    - name: === Installing RustDesk via Homebrew ===
      run: |
        brew update
        brew install --cask rustdesk
        echo "RustDesk installed!"

    - name: === Getting Exact Display Resolution ===
      id: resolution
      run: |
        # macOS command to get resolution
        RES=$(system_profiler SPDisplaysDataType | grep Resolution | awk '{print $2" "$4}')
        WIDTH=$(echo $RES | cut -d' ' -f1)
        HEIGHT=$(echo $RES | cut -d' ' -f2)

        echo "Detected resolution: ${WIDTH}x${HEIGHT}"

        echo "WIDTH=$WIDTH" >> $GITHUB_ENV
        echo "HEIGHT=$HEIGHT" >> $GITHUB_ENV

    - name: === Launch RustDesk ===
      run: |
        open -a /Applications/RustDesk.app
        sleep 5

    - name: Set timestamp
      run: echo "timestamp=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_ENV

    - name: === Process Resolution Safe ===
      run: |
        ORIGINAL_WIDTH=${WIDTH:-1024}
        ORIGINAL_HEIGHT=${HEIGHT:-768}

        # Safe arithmetic using bc (fixes AWK error)
        NEW_WIDTH=$(echo "$ORIGINAL_WIDTH * 1" | bc | awk '{print int($1)}')
        NEW_HEIGHT=$(echo "$ORIGINAL_HEIGHT * 1" | bc | awk '{print int($1)}')

        echo "Final width: $NEW_WIDTH"
        echo "Final height: $NEW_HEIGHT"

        echo "NEW_WIDTH=$NEW_WIDTH" >> $GITHUB_ENV
        echo "NEW_HEIGHT=$NEW_HEIGHT" >> $GITHUB_ENV

    - name: === Create Screenshot Folder ===
      run: |
        SCREENSHOT_DIR="$PWD/screenshots_${timestamp}"
        mkdir "$SCREENSHOT_DIR"
        echo "SCREENSHOT_DIR=$SCREENSHOT_DIR" >> $GITHUB_ENV

    - name: === Take Final Screenshot ===
      run: |
        screencapture -x "$SCREENSHOT_DIR/final.png"

    - name: === Zip & Upload Final Status ===
      uses: actions/upload-artifact@v4
      with:
        name: rustdesk-final-status
        path: |
          ${{ env.SCREENSHOT_DIR }}
          /Applications/RustDesk.app
