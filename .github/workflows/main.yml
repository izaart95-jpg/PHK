name: Sunshine macOS Testing with Tailscale

on:
  workflow_dispatch:

jobs:
  sunshine-tailscale-test:
    runs-on: macos-15
    timeout-minutes: 45

    steps:
      - name: Check macOS Version
        run: |
          echo "=== macOS Version ==="
          sw_vers
          echo "Architecture: $(uname -m)"
          system_profiler SPSoftwareDataType | grep "System Version"

      - name: Install Homebrew
        run: |
          echo "=== Installing Homebrew ==="
          
          # Check if Homebrew is already installed
          if ! command -v brew &> /dev/null; then
            echo "Installing Homebrew..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            
            # Add Homebrew to PATH for Intel
            if [ "$(uname -m)" = "x86_64" ]; then
              echo 'eval "$(/usr/local/bin/brew shellenv)"' >> ~/.zprofile
              eval "$(/usr/local/bin/brew shellenv)"
            # Add Homebrew to PATH for Apple Silicon
            elif [ "$(uname -m)" = "arm64" ]; then
              echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
              eval "$(/opt/homebrew/bin/brew shellenv)"
            fi
          else
            echo "‚úÖ Homebrew already installed"
            brew --version
          fi
          
          # Update Homebrew
          brew update

      - name: Install Tailscale
        run: |
          echo "=== Installing Tailscale ==="
          
          # Install Tailscale via Homebrew
          brew install tailscale
          
          # Start Tailscale
          echo "Starting Tailscale..."
          sudo tailscale up --authkey tskey-auth-katBTfGaCP11CNTRL-hMqSUZh4fgPZNHebqNt7gPCxLc3sP2pf
          
          # Check Tailscale status
          echo "Tailscale status:"
          tailscale status
          
          # Get Tailscale IP
          TAILSCALE_IP=$(tailscale ip -4)
          echo "Tailscale IP: $TAILSCALE_IP"
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV

      - name: Install Sunshine via LizardByte Tap
        run: |
          echo "=== Installing Sunshine ==="
          
          # Add LizardByte tap
          echo "Adding LizardByte/homebrew tap..."
          brew tap LizardByte/homebrew
          
          # Install Sunshine
          echo "Installing Sunshine..."
          brew install sunshine
          
          # Verify installation
          echo "Sunshine installation verification:"
          which sunshine
          ls -la "$(which sunshine)"
          
          # Create Sunshine config directory
          mkdir -p ~/.config/sunshine
          echo "Sunshine config directory created"

      - name: Configure Sunshine
        run: |
          echo "=== Configuring Sunshine ==="
          
          # Create basic Sunshine config
          SUNSHINE_CONFIG=~/.config/sunshine/sunshine.conf
          
          cat > "$SUNSHINE_CONFIG" << EOF
          # Sunshine Configuration
          # Generated for GitHub Actions test
          
          [nvhttp]
          port = 47989
          pkey = sunshine
          cert = sunshine
          
          [app]
          sources = 1
          
          [video]
          encoder = nvenc
          output = 1280x720
          fps = 30
          
          # Add Tailscale IP for external access
          [external_ip]
          address = ${{ env.TAILSCALE_IP }}
          EOF
          
          echo "Sunshine configuration created at: $SUNSHINE_CONFIG"
          echo "Configuration content:"
          cat "$SUNSHINE_CONFIG"

      - name: Create Screenshot Directory
        run: |
          echo "=== Creating Screenshot Directory ==="
          mkdir -p screenshots
          echo "SCREENSHOT_DIR=$(pwd)/screenshots" >> $GITHUB_ENV
          
          # Create metadata file
          METADATA_FILE="$SCREENSHOT_DIR/metadata.txt"
          echo "Sunshine + Tailscale Test Session" > "$METADATA_FILE"
          echo "=================================" >> "$METADATA_FILE"
          echo "Date: $(date)" >> "$METADATA_FILE"
          echo "macOS Version: $(sw_vers -productVersion)" >> "$METADATA_FILE"
          echo "Architecture: $(uname -m)" >> "$METADATA_FILE"
          echo "Tailscale IP: ${{ env.TAILSCALE_IP }}" >> "$METADATA_FILE"
          echo "Sunshine Version: $(sunshine --version 2>/dev/null || echo 'Unknown')" >> "$METADATA_FILE"
          echo "" >> "$METADATA_FILE"

      - name: Get Display Information
        run: |
          echo "=== Display Information ==="
          
          # Get screen resolution
          echo "Screen Information:"
          system_profiler SPDisplaysDataType | grep -A5 "Display"
          
          # Get resolution for calculations
          RESOLUTION=$(system_profiler SPDisplaysDataType 2>/dev/null | grep -A1 "Resolution:" | tail -1 | tr -d ' ' | sed 's/[^0-9x]//g')
          
          if [ -z "$RESOLUTION" ] || [ "$RESOLUTION" = "0x0" ]; then
            RESOLUTION="1440x900"  # Default for macOS runners
            echo "‚ö†Ô∏è Using default resolution: $RESOLUTION"
          else
            echo "Detected resolution: $RESOLUTION"
          fi
          
          echo "RESOLUTION=$RESOLUTION" >> $GITHUB_ENV
          echo "=== Display Info ===" >> "$SCREENSHOT_DIR/metadata.txt"
          echo "Resolution: $RESOLUTION" >> "$SCREENSHOT_DIR/metadata.txt"

      - name: Start Sunshine Service
        run: |
          echo "=== Starting Sunshine ==="
          
          # Kill any existing Sunshine processes
          pkill -f sunshine 2>/dev/null || true
          sleep 2
          
          # Start Sunshine in the background
          echo "Starting Sunshine service..."
          sunshine --creds &> "$SCREENSHOT_DIR/sunshine_start.log" &
          SUNSHINE_PID=$!
          echo "SUNSHINE_PID=$SUNSHINE_PID" >> $GITHUB_ENV
          
          # Wait for Sunshine to start
          echo "Waiting for Sunshine to initialize..."
          sleep 10
          
          # Check if Sunshine is running
          if ps -p $SUNSHINE_PID > /dev/null; then
            echo "‚úÖ Sunshine started successfully (PID: $SUNSHINE_PID)"
            echo "Sunshine PID: $SUNSHINE_PID" >> "$SCREENSHOT_DIR/metadata.txt"
          else
            echo "‚ö†Ô∏è Sunshine may not have started correctly"
            echo "Check log: $SCREENSHOT_DIR/sunshine_start.log"
            cat "$SCREENSHOT_DIR/sunshine_start.log"
          fi
          
          # Check listening ports
          echo "Checking listening ports..."
          lsof -i -P -n | grep LISTEN | grep -E "(sunshine|47989)" || true

      - name: Initial Screenshots (5 screenshots, 1 per second)
        run: |
          echo "=== Taking 5 Initial Screenshots (1 per second) ==="
          
          for i in {1..5}; do
            timestamp=$(date +%Y%m%d_%H%M%S)
            screenshot_file="$SCREENSHOT_DIR/01_initial_${i}_${timestamp}.png"
            
            echo "Taking screenshot $i..."
            screencapture -x "$screenshot_file"
            
            if [ -f "$screenshot_file" ]; then
              filesize=$(ls -lh "$screenshot_file" | awk '{print $5}')
              echo "‚úÖ Screenshot $i: $filesize"
              
              # Add to metadata
              echo "Screenshot $i: $(basename "$screenshot_file") ($filesize)" >> "$SCREENSHOT_DIR/metadata.txt"
            else
              echo "‚ö†Ô∏è Failed to take screenshot $i"
            fi
            
            # Wait 1 second between screenshots
            if [ $i -lt 5 ]; then
              sleep 1
            fi
          done
          
          echo "‚úÖ Initial screenshot sequence complete"

      - name: Upload Initial Screenshots
        uses: actions/upload-artifact@v4
        with:
          name: sunshine-initial-screenshots
          path: ${{ env.SCREENSHOT_DIR }}/01_initial_*.png
          retention-days: 7

      - name: Extended Monitoring (10 minutes, 2 screenshots per minute)
        run: |
          echo "=== Starting 10-Minute Extended Monitoring ==="
          echo "Will take 2 screenshots per minute for 10 minutes"
          echo "Total: 20 additional screenshots"
          
          # Calculate total minutes
          TOTAL_MINUTES=10
          SCREENSHOTS_PER_MINUTE=2
          TOTAL_SCREENSHOTS=$((TOTAL_MINUTES * SCREENSHOTS_PER_MINUTE))
          
          echo "Duration: $TOTAL_MINUTES minutes"
          echo "Screenshots per minute: $SCREENSHOTS_PER_MINUTE"
          echo "Total expected screenshots: $TOTAL_SCREENSHOTS"
          echo ""
          echo "Starting at: $(date)"
          
          # Create monitoring log
          MONITOR_LOG="$SCREENSHOT_DIR/monitoring.log"
          echo "Extended Monitoring Log" > "$MONITOR_LOG"
          echo "======================" >> "$MONITOR_LOG"
          echo "Start time: $(date)" >> "$MONITOR_LOG"
          echo "Duration: $TOTAL_MINUTES minutes" >> "$MONITOR_LOG"
          
          # Monitor loop
          for minute in $(seq 1 $TOTAL_MINUTES); do
            echo ""
            echo "=== Minute $minute/$TOTAL_MINUTES ==="
            echo "Minute $minute started at: $(date +%H:%M:%S)" >> "$MONITOR_LOG"
            
            # Take screenshots for this minute
            for shot_num in $(seq 1 $SCREENSHOTS_PER_MINUTE); do
              screenshot_counter=$(((minute - 1) * SCREENSHOTS_PER_MINUTE + shot_num + 5))
              
              # Format counter with leading zeros
              counter_formatted=$(printf "%02d" $screenshot_counter)
              timestamp=$(date +%Y%m%d_%H%M%S)
              screenshot_file="$SCREENSHOT_DIR/${counter_formatted}_monitoring_${timestamp}.png"
              
              echo "Taking screenshot $counter_formatted..."
              screencapture -x "$screenshot_file"
              
              if [ -f "$screenshot_file" ]; then
                filesize=$(ls -lh "$screenshot_file" | awk '{print $5}')
                echo "‚úÖ Screenshot $counter_formatted: $filesize"
                
                # Log to monitoring file
                echo "  Screenshot $counter_formatted: $(basename "$screenshot_file") ($filesize)" >> "$MONITOR_LOG"
              else
                echo "‚ö†Ô∏è Failed to take screenshot $counter_formatted"
              fi
              
              # Wait between screenshots in the same minute (except after last)
              if [ $shot_num -lt $SCREENSHOTS_PER_MINUTE ]; then
                sleep 30  # 30 seconds between screenshots in same minute
              fi
            done
            
            # Wait for next minute (unless this is the last minute)
            if [ $minute -lt $TOTAL_MINUTES ]; then
              echo "Waiting for next minute..."
              sleep 30  # Already waited 30 seconds for second screenshot
            fi
            
            # Log system info every 2 minutes
            if [ $((minute % 2)) -eq 0 ]; then
              echo "System status at minute $minute:" >> "$MONITOR_LOG"
              echo "CPU: $(ps -A -o %cpu | awk '{s+=$1} END {print s "%"}')" >> "$MONITOR_LOG"
              echo "Memory: $(memory_pressure | grep -E "System-wide memory free percentage:|System-wide memory free percentage")" >> "$MONITOR_LOG"
              
              # Check if Sunshine is still running
              if ps -p ${{ env.SUNSHINE_PID }} > /dev/null 2>&1; then
                echo "Sunshine: Running (PID: ${{ env.SUNSHINE_PID }})" >> "$MONITOR_LOG"
              else
                echo "Sunshine: NOT RUNNING" >> "$MONITOR_LOG"
              fi
            fi
          done
          
          echo ""
          echo "‚úÖ Extended monitoring complete!"
          echo "End time: $(date)" >> "$MONITOR_LOG"
          echo "Total monitoring duration: $TOTAL_MINUTES minutes" >> "$MONITOR_LOG"

      - name: Final System Check
        run: |
          echo "=== Final System Check ==="
          
          # Create system check file
          SYSTEM_CHECK="$SCREENSHOT_DIR/system_check.txt"
          
          echo "Final System Status" > "$SYSTEM_CHECK"
          echo "===================" >> "$SYSTEM_CHECK"
          echo "Check time: $(date)" >> "$SYSTEM_CHECK"
          echo "" >> "$SYSTEM_CHECK"
          
          # Check running processes
          echo "Running Processes:" >> "$SYSTEM_CHECK"
          echo "-----------------" >> "$SYSTEM_CHECK"
          ps aux | grep -E "(sunshine|tailscale)" | grep -v grep >> "$SYSTEM_CHECK" || echo "No matching processes found" >> "$SYSTEM_CHECK"
          echo "" >> "$SYSTEM_CHECK"
          
          # Check network connections
          echo "Network Connections:" >> "$SYSTEM_CHECK"
          echo "-------------------" >> "$SYSTEM_CHECK"
          lsof -i -P -n | grep -E "(sunshine|tailscale|47989)" >> "$SYSTEM_CHECK" || echo "No matching connections" >> "$SYSTEM_CHECK"
          echo "" >> "$SYSTEM_CHECK"
          
          # Check Tailscale status
          echo "Tailscale Final Status:" >> "$SYSTEM_CHECK"
          echo "----------------------" >> "$SYSTEM_CHECK"
          tailscale status >> "$SYSTEM_CHECK" 2>&1 || echo "Tailscale command failed" >> "$SYSTEM_CHECK"
          echo "" >> "$SYSTEM_CHECK"
          
          # Count screenshots
          TOTAL_SCREENSHOTS=$(find "$SCREENSHOT_DIR" -name "*.png" | wc -l)
          echo "Total Screenshots Captured: $TOTAL_SCREENSHOTS" >> "$SYSTEM_CHECK"
          echo "" >> "$SYSTEM_CHECK"
          
          # Disk usage
          echo "Storage Usage:" >> "$SYSTEM_CHECK"
          echo "-------------" >> "$SYSTEM_CHECK"
          du -sh "$SCREENSHOT_DIR" >> "$SYSTEM_CHECK"
          
          echo "‚úÖ System check complete"

      - name: Upload Monitoring Screenshots and Logs
        uses: actions/upload-artifact@v4
        with:
          name: sunshine-monitoring-data
          path: |
            ${{ env.SCREENSHOT_DIR }}/0[2-9]_*.png
            ${{ env.SCREENSHOT_DIR }}/[1-9][0-9]_*.png
            ${{ env.SCREENSHOT_DIR }}/monitoring.log
            ${{ env.SCREENSHOT_DIR }}/system_check.txt
            ${{ env.SCREENSHOT_DIR }}/sunshine_start.log
          retention-days: 7

      - name: Cleanup
        run: |
          echo "=== Cleaning Up ==="
          
          # Stop Sunshine
          echo "Stopping Sunshine..."
          pkill -f sunshine 2>/dev/null || true
          
          # Disconnect Tailscale
          echo "Disconnecting Tailscale..."
          sudo tailscale down 2>/dev/null || true
          
          # Kill any remaining processes
          sleep 2
          pkill -9 -f sunshine 2>/dev/null || true
          
          # List all artifacts
          echo ""
          echo "=== Final Artifact Summary ==="
          echo "Screenshots directory: $SCREENSHOT_DIR"
          echo "Total screenshots: $(find "$SCREENSHOT_DIR" -name "*.png" 2>/dev/null | wc -l)"
          ls -lh "$SCREENSHOT_DIR"/

      - name: Final Report
        run: |
          echo "=== Sunshine + Tailscale Test Complete ==="
          echo ""
          echo "üìä Test Summary:"
          echo "  macOS Version: $(sw_vers -productVersion)"
          echo "  Architecture: $(uname -m)"
          echo "  Tailscale IP: ${{ env.TAILSCALE_IP }}"
          echo "  Initial Screenshots: 5 (1 per second)"
          echo "  Monitoring Screenshots: 20 (2 per minute for 10 minutes)"
          echo "  Total Screenshots: $(find "$SCREENSHOT_DIR" -name "*.png" 2>/dev/null | wc -l)"
          echo "  Test duration: ~15-20 minutes"
          echo "  Sunshine running: $(ps -p ${{ env.SUNSHINE_PID }} >/dev/null 2>&1 && echo 'Yes' || echo 'No')"
          echo ""
          echo "‚úÖ Workflow completed successfully!"
          echo ""
          echo "üìÅ Artifacts generated:"
          echo "  1. sunshine-initial-screenshots - First 5 screenshots"
          echo "  2. sunshine-monitoring-data - Remaining screenshots + logs"
