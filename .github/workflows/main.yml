name: SSHX Remote Access with Sunshine

on:
  workflow_dispatch:

env:
  SSHX_SESSION_FILE: /tmp/sshx_session.log
  SSHX_PID: 0
  SUNSHINE_PID: 0

jobs:
  setup-sshx:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours total

    steps:
      - name: Install dependencies
        run: |
          echo "=== Installing basic dependencies ==="
          sudo apt-get update
          sudo apt-get install -y curl wget gdebi-core
          echo "âœ… Dependencies installed"

      - name: Install sshx and show URL
        run: |
          echo "=== Installing sshx ==="
          curl -sSf https://sshx.io/get | sh
          
          echo ""
          echo "=== Starting sshx session ==="
          
          # Run sshx and capture output to file
          sshx 2>&1 | tee "$SSHX_SESSION_FILE" &
          SSHX_PID=$!
          echo "SSHX_PID=$SSHX_PID" >> $GITHUB_ENV
          
          # Wait for sshx to start
          sleep 10
          
          # Check if sshx is running
          if ps -p $SSHX_PID > /dev/null 2>&1; then
            echo "âœ… sshx running with PID: $SSHX_PID"
          else
            echo "âš ï¸ sshx may have exited"
          fi
          
          # Extract and show the sshx URL
          echo ""
          echo "=== SSHX Connection URL ==="
          if [ -f "$SSHX_SESSION_FILE" ]; then
            # Look for the sshx.io URL in the output
            SSHX_URL=$(grep -o "https://sshx.io/[a-zA-Z0-9-]\+" "$SSHX_SESSION_FILE" | head -1 || true)
            if [ ! -z "$SSHX_URL" ]; then
              echo "ğŸ”— Connect via: $SSHX_URL"
              echo "SSHX_URL=$SSHX_URL" >> $GITHUB_ENV
            else
              echo "âš ï¸ Could not extract SSHX URL from logs"
              echo "=== Last 10 lines of sshx output ==="
              tail -10 "$SSHX_SESSION_FILE" || true
            fi
          fi

      - name: Install Ubuntu Desktop and VNC
        run: |
          echo "=== Installing Ubuntu Desktop and VNC ==="
          
          # Install required packages
          sudo apt-get update
          sudo apt-get install -y \
            ubuntu-desktop \
            tigervnc-standalone-server \
            dbus-x11 \
            mesa-utils \
            vainfo
            
          echo "âœ… Ubuntu Desktop and VNC installed"
          
          # Check VA-API support
          echo "=== Checking VA-API support ==="
          vainfo || echo "VA-API not available"

      - name: Install Tailscale
        run: |
          echo "=== Installing Tailscale ==="
          
          # Install Tailscale
          curl -fsSL https://tailscale.com/install.sh | sh
          
          # Start Tailscale with auth key
          sudo tailscale up --auth-key "tskey-auth-katBTfGaCP11CNTRL-hMqSUZh4fgPZNHebqNt7gPCxLc3sP2pf" --hostname "github-runner-$(date +%s)" &
          
          echo "âœ… Tailscale installed and connecting in background"
          
          # Wait a bit for connection
          sleep 15
          
          # Show Tailscale status
          echo "=== Tailscale Status ==="
          sudo tailscale status || true

      - name: Install Sunshine
        run: |
          echo "=== Installing Sunshine ==="
          
          # Download Sunshine
          SUNSHINE_URL="https://github.com/LizardByte/Sunshine/releases/download/v2025.924.154138/sunshine-ubuntu-24.04-amd64.deb"
          SUNSHINE_DEB="sunshine.deb"
          
          echo "Downloading Sunshine from: $SUNSHINE_URL"
          wget -O "$SUNSHINE_DEB" "$SUNSHINE_URL"
          
          # Install dependencies first
          echo "Installing Sunshine dependencies..."
          sudo apt-get update
          sudo apt-get install -y \
            libboost-thread1.74.0 \
            libboost-log1.74.0 \
            libboost-filesystem1.74.0 \
            libboost-chrono1.74.0 \
            libboost-atomic1.74.0 \
            libavcodec60 \
            libavformat60 \
            libavutil58 \
            libswscale7 \
            libswresample4 \
            libopus0 \
            libnuma1 \
            libmfx1 \
            libva-drm2 \
            libva-x11-2 \
            libva2 \
            libssl3 \
            libpulse0 \
            libx264-164 \
            libx265-199 \
            libvpx9 \
            libdrm2 \
            libwayland-client0 \
            libxkbcommon0
            
          # Install Sunshine using gdebi to handle dependencies better
          echo "Installing Sunshine package..."
          sudo gdebi -n "$SUNSHINE_DEB"
          
          echo "âœ… Sunshine installed"
          
          # Create Sunshine configuration directory and basic config
          echo "Creating Sunshine configuration..."
          mkdir -p ~/.config/sunshine
          
          # Create minimal config file
          cat > ~/.config/sunshine/sunshine.conf << 'EOF'
{
  "global": {
    "prep-cmd": [],
    "origin_web_ui_allowed": "host"
  },
  "creds": {
    "username": "sunshine",
    "password": "sunshine",
    "salt": "sunshine"
  }
}
EOF
          
          echo "=== Starting Sunshine ==="
          # Start Sunshine in background
          /usr/bin/sunshine-2025.924.154138 &
          SUNSHINE_PID=$!
          echo "Sunshine PID: $SUNSHINE_PID"
          echo "SUNSHINE_PID=$SUNSHINE_PID" >> $GITHUB_ENV
          
          # Wait for Sunshine to start
          sleep 10
          
          echo "Sunshine should now be running on:"
          echo "  - Web interface: http://localhost:47990"
          echo "  - Streaming port: 47989"
          echo "  - Default credentials: sunshine / sunshine"
          
          # Check if Sunshine is running
          if ps -p $SUNSHINE_PID > /dev/null 2>&1; then
            echo "âœ… Sunshine is running successfully"
          else
            echo "âš ï¸ Sunshine failed to start, checking logs..."
            # Try to start with verbose output
            /usr/bin/sunshine-2025.924.154138 --verbose &
            sleep 5
          fi

      - name: Keep SSHX alive for 6 hours
        run: |
          echo "=== SSHX Remote Access Active ==="
          echo ""
          echo "Start time: $(date)"
          echo "Will keep alive until: $(date -d '+6 hours')"
          echo ""
          
          # Display SSHX connection info
          if [ -f "$SSHX_SESSION_FILE" ]; then
            echo "=== SSHX Session Information ==="
            SSHX_URL=$(grep -o "https://sshx.io/[a-zA-Z0-9-]\+" "$SSHX_SESSION_FILE" | head -1 || true)
            if [ ! -z "$SSHX_URL" ]; then
              echo "ğŸ”— SSHX Connection URL: $SSHX_URL"
            else
              echo "âš ï¸ SSHX URL not found in logs"
            fi
            echo ""
          fi
          
          # Display Tailscale IP if connected
          echo "=== Tailscale Status ==="
          sudo tailscale ip 2>/dev/null | head -1 | while read ip; do
            echo "ğŸŒ Tailscale IP: $ip"
          done || echo "Tailscale IP not available"
          echo ""
          
          # Display Sunshine info
          echo "=== Sunshine Information ==="
          echo "ğŸŒ Sunshine Web Interface: http://localhost:47990"
          echo "ğŸŒ Sunshine Streaming Port: 47989"
          echo "ğŸŒ Default credentials:"
          echo "    Username: sunshine"
          echo "    Password: sunshine"
          echo "ğŸŒ Connect via Tailscale: http://<tailscale-ip>:47990"
          echo ""
          
          # Display connection instructions
          echo "=== Connection Instructions ==="
          echo "1. Connect via SSHX URL above"
          echo "2. Once connected, you can access:"
          echo "   - Sunshine Web UI: http://localhost:47990"
          echo "   - Ubuntu Desktop: (via VNC or Sunshine stream)"
          echo "3. To connect from outside via Tailscale:"
          echo "   - Install Tailscale on your device"
          echo "   - Use the Tailscale IP shown above"
          echo ""
          
          # Keep alive for 6 hours (360 minutes)
          TOTAL_MINUTES=360
          for minute in $(seq 1 $TOTAL_MINUTES); do
            echo "=== Minute $minute/$TOTAL_MINUTES ==="
            echo "Time: $(date)"
            echo "Elapsed: $((minute / 60))h $((minute % 60))m"
            echo "Remaining: $(((TOTAL_MINUTES - minute) / 60))h $(((TOTAL_MINUTES - minute) % 60))m"
            
            # Check if sshx is running
            if [ ! -z "$SSHX_PID" ] && ps -p $SSHX_PID > /dev/null 2>&1; then
              echo "âœ… sshx: Running (PID: $SSHX_PID)"
            else
              echo "âŒ sshx: Not running, attempting to restart..."
              # Kill any remaining sshx processes
              pkill -f "sshx" 2>/dev/null || true
              sleep 2
              # Restart sshx
              sshx 2>&1 | tee -a "$SSHX_SESSION_FILE" &
              SSHX_PID=$!
              echo "New PID: $SSHX_PID"
              echo "SSHX_PID=$SSHX_PID" >> $GITHUB_ENV
              sleep 10
            fi
            
            # Check other services every 5 minutes
            if [ $((minute % 5)) -eq 0 ]; then
              echo "=== Service Status Check ==="
              
              # Check Tailscale
              if sudo tailscale status 2>/dev/null | grep -q "active"; then
                echo "âœ… Tailscale: Connected"
                # Show Tailscale IP
                TAILSCALE_IP=$(sudo tailscale ip 2>/dev/null | head -1 || echo "")
                if [ ! -z "$TAILSCALE_IP" ]; then
                  echo "   IP Address: $TAILSCALE_IP"
                  echo "   Sunshine via Tailscale: http://$TAILSCALE_IP:47990"
                fi
              else
                echo "âš ï¸ Tailscale: Not connected, attempting restart..."
                sudo tailscale up --auth-key "tskey-auth-katBTfGaCP11CNTRL-hMqSUZh4fgPZNHebqNt7gPCxLc3sP2pf" --reset || true
              fi
              
              # Check Sunshine
              SUNSHINE_PROCESS=$(pgrep -f "sunshine" || echo "")
              if [ ! -z "$SUNSHINE_PROCESS" ]; then
                echo "âœ… Sunshine: Running (PID: $SUNSHINE_PROCESS)"
                echo "   Web Interface: http://localhost:47990"
                echo "   Streaming: port 47989"
              else
                echo "âš ï¸ Sunshine: Not running, attempting restart..."
                # Kill any remaining sunshine processes
                pkill -f "sunshine" 2>/dev/null || true
                sleep 2
                # Restart Sunshine
                /usr/bin/sunshine-2025.924.154138 &
                SUNSHINE_PID=$!
                echo "SUNSHINE_PID=$SUNSHINE_PID" >> $GITHUB_ENV
                sleep 5
              fi
            fi
            
            # Wait for next minute
            if [ $minute -lt $TOTAL_MINUTES ]; then
              echo "â³ Waiting 60 seconds..."
              sleep 60
            fi
          done
          
          echo ""
          echo "âœ… 6 hours complete. Session ending."

      - name: Cleanup
        if: always()
        run: |
          echo "=== Cleaning up ==="
          
          # Kill sshx process
          if [ ! -z "$SSHX_PID" ] && ps -p $SSHX_PID > /dev/null 2>&1; then
            echo "Stopping sshx (PID: $SSHX_PID)..."
            kill $SSHX_PID 2>/dev/null || true
            sleep 2
          fi
          
          # Kill any other sshx processes
          pkill -f "sshx" 2>/dev/null || true
          
          # Kill Sunshine
          echo "Stopping Sunshine..."
          pkill -f "sunshine" 2>/dev/null || true
          
          # Stop Tailscale
          echo "Stopping Tailscale..."
          sudo tailscale down 2>/dev/null || true
          
          echo "âœ… Cleanup complete"
