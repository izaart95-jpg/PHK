name: macOS Login Screen Capture Test

on:
  workflow_dispatch:

jobs:
  login-screen-test:
    runs-on: macos-latest
    timeout-minutes: 25

    steps:
      - name: Check macOS Version
        run: |
          echo "=== macOS Version ==="
          sw_vers
          echo "RUNNER_OS=$RUNNER_OS" >> $GITHUB_ENV

      - name: Create Screenshot Directory
        run: |
          echo "=== Creating Screenshot Directory ==="
          mkdir -p screenshots
          echo "SCREENSHOT_DIR=$(pwd)/screenshots" >> $GITHUB_ENV

      - name: Initial Screenshot
        run: |
          echo "=== Taking Initial Screenshot ==="
          timestamp=$(date +%Y%m%d_%H%M%S)
          screenshot_file="$SCREENSHOT_DIR/01_initial_desktop_$timestamp.png"
          screencapture -x "$screenshot_file"
          echo "‚úÖ Initial screenshot saved: $screenshot_file"

      - name: Create Admin User Hamiya
        run: |
          echo "=== Creating Admin User Hamiya ==="
          
          # Check if user already exists
          if id "Hamiya" &>/dev/null; then
            echo "‚ö†Ô∏è User Hamiya already exists, deleting first..."
            sudo dscl . -delete /Users/Hamiya 2>/dev/null || true
            sleep 1
          fi
          
          # Create new user
          echo "Creating user 'Hamiya'..."
          sudo sysadminctl -addUser Hamiya -fullName "Hamiya User" -password "Hamza@157"
          
          # Add user to admin group
          echo "Adding 'Hamiya' to admin group..."
          sudo dseditgroup -o edit -a Hamiya -t user admin
          
          # Verify creation
          echo "Verifying user creation:"
          id Hamiya
          
          # Verify admin membership
          echo "Verifying admin membership:"
          sudo dscl . read /Groups/admin GroupMembership | grep Hamiya || echo "Hamiya not found in admin group"
          
          echo "‚úÖ User Hamiya created with admin privileges"

      - name: Install cliclick
        run: |
          echo "=== Installing cliclick ==="
          
          if ! command -v cliclick &> /dev/null; then
            echo "Installing cliclick..."
            brew install cliclick
          else
            echo "‚úÖ cliclick already installed"
          fi
          
          # Verify installation
          cliclick -v || echo "cliclick version check failed"
          
          # Make sure it's in PATH
          export PATH="/opt/homebrew/bin:$PATH"

      - name: Attempt Login Screen Capture Method 1
        run: |
          echo "=== Attempt 1: Using sudo login ==="
          
          # Take screenshot before login attempt
          screenshot_file="$SCREENSHOT_DIR/02_before_login_attempt_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "üì∏ Screenshot before login attempt"
          
          # Create a script to handle the login
          cat > switch_user.sh << 'EOF'
          #!/bin/bash
          
          echo "Attempting to switch to Hamiya user..."
          
          # Method 1: Try sudo login
          echo "Trying sudo login method..."
          echo "Hamiya" | sudo login Hamiya 2>/dev/null &
          LOGIN_PID=$!
          
          # Wait a bit for login screen
          sleep 3
          
          # Take screenshot of login screen
          sudo screencapture -x "$SCREENSHOT_DIR/03_login_screen_attempt_$(date +%H%M%S).png"
          
          # Kill the login process
          kill $LOGIN_PID 2>/dev/null || true
          
          # Return to original user
          sleep 2
          
          echo "Login attempt completed"
          EOF
          
          chmod +x switch_user.sh
          
          # Run the script in background
          ./switch_user.sh &
          SWITCH_PID=$!
          
          # Wait for it to complete
          sleep 5
          
          # Take screenshot after attempt
          screenshot_file="$SCREENSHOT_DIR/04_after_login_attempt_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "üì∏ Screenshot after login attempt"

      - name: Attempt Login Screen Capture Method 2
        run: |
          echo "=== Attempt 2: Using CGSession ==="
          
          # Take screenshot before CGSession
          screenshot_file="$SCREENSHOT_DIR/05_before_cgsession_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "üì∏ Screenshot before CGSession"
          
          # Switch to Hamiya using CGSession
          echo "Switching to Hamiya using CGSession..."
          sudo /System/Library/CoreServices/Menu\ Extras/User.menu/Contents/Resources/CGSession -switchToUser Hamiya &
          CGSESSION_PID=$!
          
          # Wait for switch
          sleep 3
          
          # Attempt to capture login screen with cliclick
          echo "Attempting to capture with cliclick..."
          
          # Click at 17,19 (as requested)
          cliclick c:17,19 2>/dev/null || echo "Click at 17,19 failed"
          
          # Take screenshot after click
          screenshot_file="$SCREENSHOT_DIR/06_after_click_17_19_$(date +%H%M%S).png"
          sudo screencapture -x "$screenshot_file" 2>/dev/null || echo "Screenshot failed"
          echo "üì∏ Attempted screenshot after click at 17,19"
          
          # Click somewhere else (let's try 100,100)
          cliclick c:100,100 2>/dev/null || echo "Click at 100,100 failed"
          
          # Take another screenshot
          screenshot_file="$SCREENSHOT_DIR/07_after_click_100_100_$(date +%H%M%S).png"
          sudo screencapture -x "$screenshot_file" 2>/dev/null || echo "Screenshot failed"
          echo "üì∏ Attempted screenshot after click at 100,100"
          
          # Try to return to original user
          echo "Attempting to return to original session..."
          
          # Kill CGSession process
          kill $CGSESSION_PID 2>/dev/null || true
          
          # Try to switch back using CGSession with current user
          CURRENT_USER=$(whoami)
          sudo /System/Library/CoreServices/Menu\ Extras/User.menu/Contents/Resources/CGSession -switchToUser $CURRENT_USER 2>/dev/null || true
          
          sleep 2

      - name: Direct Login Screen Interaction Test
        run: |
          echo "=== Direct Login Screen Test ==="
          
          # Create a more aggressive test
          echo "Creating test script for direct interaction..."
          
          cat > login_test.sh << 'EOF'
          #!/bin/bash
          
          echo "Starting direct login screen test..."
          
          # Switch to login screen
          echo "Switching to login screen..."
          sudo /System/Library/CoreServices/Menu\ Extras/User.menu/Contents/Resources/CGSession -suspend &
          
          # Wait for login screen
          sleep 4
          
          # Now we should be at login screen
          echo "At login screen, attempting interactions..."
          
          # Click at various positions to see if we can interact
          for click_num in 1 2 3; do
            echo "Click attempt $click_num..."
            
            # Different coordinates each time
            case $click_num in
              1) X=17 Y=19 ;;
              2) X=100 Y=200 ;;
              3) X=200 Y=100 ;;
            esac
            
            # Try to click
            /opt/homebrew/bin/cliclick c:$X,$Y 2>/dev/null || echo "Click failed at $X,$Y"
            
            # Try to take screenshot
            sudo screencapture -x "$SCREENSHOT_DIR/login_screen_click_${click_num}_$(date +%H%M%S).png" 2>/dev/null || echo "Screenshot failed"
            
            sleep 1
          done
          
          # Try to return from login screen
          echo "Attempting to return..."
          
          # Press Escape key (might wake from screensaver/login)
          osascript -e 'tell application "System Events" to key code 53' 2>/dev/null || true
          
          # Press Enter
          osascript -e 'tell application "System Events" to key code 36' 2>/dev/null || true
          
          # Try to switch back to current user
          CURRENT_USER=$(whoami)
          sudo /System/Library/CoreServices/Menu\ Extras/User.menu/Contents/Resources/CGSession -switchToUser $CURRENT_USER 2>/dev/null || true
          
          echo "Direct test completed"
          EOF
          
          chmod +x login_test.sh
          
          # Run the test
          ./login_test.sh &
          LOGIN_TEST_PID=$!
          
          # Wait for test to complete
          sleep 10
          
          # Take final screenshot
          screenshot_file="$SCREENSHOT_DIR/08_after_direct_test_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "üì∏ Final screenshot after direct test"

      - name: Post-Test Screenshots
        run: |
          echo "=== Post-Test Verification ==="
          
          # Check if we're back to normal
          echo "Checking current session..."
          whoami
          
          # Take several verification screenshots
          for i in {1..5}; do
            screenshot_file="$SCREENSHOT_DIR/09_post_test_${i}_$(date +%H%M%S).png"
            screencapture -x "$screenshot_file"
            echo "üì∏ Post-test screenshot $i"
            sleep 1
          done

      - name: Capture Test Information
        run: |
          echo "=== Capturing Test Information ==="
          
          INFO_FILE="$SCREENSHOT_DIR/test_info.txt"
          
          echo "macOS Login Screen Capture Test Report" > "$INFO_FILE"
          echo "=====================================" >> "$INFO_FILE"
          echo "Test Date: $(date)" >> "$INFO_FILE"
          echo "macOS Version: $(sw_vers -productVersion)" >> "$INFO_FILE"
          echo "Current User: $(whoami)" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          echo "Test User Information:" >> "$INFO_FILE"
          echo "---------------------" >> "$INFO_FILE"
          echo "Created User: Hamiya" >> "$INFO_FILE"
          echo "User Password: Hamza@157" >> "$INFO_FILE"
          echo "Is Admin: $(dscl . -read /Groups/admin GroupMembership | grep -q Hamiya && echo "Yes" || echo "No")" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          echo "Test Methods Attempted:" >> "$INFO_FILE"
          echo "----------------------" >> "$INFO_FILE"
          echo "1. sudo login Hamiya" >> "$INFO_FILE"
          echo "2. CGSession -switchToUser Hamiya" >> "$INFO_FILE"
          echo "3. Direct login screen interaction with cliclick" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          echo "Click Coordinates Tested:" >> "$INFO_FILE"
          echo "------------------------" >> "$INFO_FILE"
          echo "‚Ä¢ (17, 19) - Primary test coordinate" >> "$INFO_FILE"
          echo "‚Ä¢ (100, 100) - Secondary test" >> "$INFO_FILE"
          echo "‚Ä¢ (100, 200) - Additional test" >> "$INFO_FILE"
          echo "‚Ä¢ (200, 100) - Additional test" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          echo "Technical Notes:" >> "$INFO_FILE"
          echo "---------------" >> "$INFO_FILE"
          echo "‚Ä¢ GitHub Actions runners typically run as '_runner' or similar service account" >> "$INFO_FILE"
          echo "‚Ä¢ Login screen capture is challenging due to macOS security (TCC, Screen Recording permissions)" >> "$INFO_FILE"
          echo "‚Ä¢ The login screen runs in a separate, secure context (WindowServer)" >> "$INFO_FILE"
          echo "‚Ä¢ Direct GUI automation of login screen may not work in headless/CI environments" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          echo "Screenshots Captured:" >> "$INFO_FILE"
          echo "-------------------" >> "$INFO_FILE"
          find "$SCREENSHOT_DIR" -name "*.png" -exec basename {} \; | sort >> "$INFO_FILE"
          
          echo "" >> "$INFO_FILE"
          echo "Total screenshots: $(find "$SCREENSHOT_DIR" -name "*.png" | wc -l)" >> "$INFO_FILE"

      - name: Cleanup
        run: |
          echo "=== Final Cleanup ==="
          
          # Make sure we're back to normal state
          echo "Ensuring clean state..."
          
          # Kill any remaining processes
          pkill -f "CGSession" 2>/dev/null || true
          pkill -f "login" 2>/dev/null || true
          
          # Take one final screenshot
          screenshot_file="$SCREENSHOT_DIR/final_complete_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "üì∏ Final completion screenshot"

      - name: Upload Screenshots
        uses: actions/upload-artifact@v4
        with:
          name: login-screen-capture-test
          path: |
            ${{ env.SCREENSHOT_DIR }}
          retention-days: 7

      - name: Upload Summary
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: login-screen-test-summary
          path: |
            ${{ env.SCREENSHOT_DIR }}/test_info.txt
          retention-days: 7

      - name: Final Report
        run: |
          echo "=== Login Screen Capture Test Complete ==="
          echo ""
          echo "üìä Summary:"
          echo "  ‚úÖ macOS Version: $(sw_vers -productVersion)"
          echo "  ‚úÖ User 'Hamiya' created with password 'Hamza@157'"
          echo "  ‚úÖ User added to admin group"
          SCREENSHOT_COUNT=$(find "$SCREENSHOT_DIR" -name "*.png" 2>/dev/null | wc -l | tr -d ' ')
          echo "  ‚úÖ $SCREENSHOT_COUNT screenshots attempted"
          echo ""
          echo "üîÑ Methods Tested:"
          echo "  1. sudo login Hamiya"
          echo "  2. CGSession -switchToUser Hamiya"
          echo "  3. Direct login screen interaction"
          echo ""
          echo "üéØ Actions Performed:"
          echo "  ‚Ä¢ Clicked at (17, 19) on login screen"
          echo "  ‚Ä¢ Clicked at other test coordinates"
          echo "  ‚Ä¢ Attempted multiple screenshot captures"
          echo ""
          echo "‚ö†Ô∏è Important Note:"
          echo "Login screen capture in CI environments is challenging due to:"
          echo "  ‚Ä¢ macOS security restrictions (TCC)"
          echo "  ‚Ä¢ Screen Recording permissions"
          echo "  ‚Ä¢ Headless environment limitations"
          echo "  ‚Ä¢ Secure input context of login screen"
          echo ""
          echo "Some screenshots may be black or fail due to these restrictions."
          echo ""
          echo "üìÅ Artifacts uploaded for review."
          echo "‚úÖ Test completed!"
