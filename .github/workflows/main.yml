name: RealVNC Connect Installation and Screenshots

on:
  workflow_dispatch:
    inputs:
      vnc_version:
        description: 'RealVNC version (default: 3.2.0)'
        required: false
        default: '3.2.0'

jobs:
  realvnc-installation:
    runs-on: macos-15
    timeout-minutes: 30

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Environment
        run: |
          echo "=== Setting Up Environment ==="
          echo "macOS Version: $(sw_vers -productVersion)"
          echo "GitHub Runner: ${{ runner.os }}"
          
          # Create directories
          mkdir -p downloads screenshots logs
          
          # Set environment variables
          VNC_VERSION="${{ inputs.vnc_version || '3.2.0' }}"
          DOWNLOAD_URL="https://downloads.realvnc.com/download/file/realvnc-connect/RealVNC-Connect-Installer-${VNC_VERSION}-MacOSX-universal.zip"
          DOWNLOAD_PATH="$(pwd)/downloads/RealVNC-Connect-${VNC_VERSION}.zip"
          EXTRACT_PATH="$(pwd)/downloads/RealVNC-Connect"
          SCREENSHOT_DIR="$(pwd)/screenshots"
          LOG_DIR="$(pwd)/logs"
          
          echo "VNC_VERSION=$VNC_VERSION" >> $GITHUB_ENV
          echo "DOWNLOAD_URL=$DOWNLOAD_URL" >> $GITHUB_ENV
          echo "DOWNLOAD_PATH=$DOWNLOAD_PATH" >> $GITHUB_ENV
          echo "EXTRACT_PATH=$EXTRACT_PATH" >> $GITHUB_ENV
          echo "SCREENSHOT_DIR=$SCREENSHOT_DIR" >> $GITHUB_ENV
          echo "LOG_DIR=$LOG_DIR" >> $GITHUB_ENV
          echo "WORKING_DIR=$(pwd)" >> $GITHUB_ENV

      - name: Download RealVNC Connect
        run: |
          echo "=== Downloading RealVNC Connect ==="
          echo "Download URL: $DOWNLOAD_URL"
          echo "Save Path: $DOWNLOAD_PATH"
          
          # Download with retries and progress
          for attempt in {1..3}; do
            echo "Download attempt $attempt..."
            if curl -L "$DOWNLOAD_URL" \
                -H "User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36" \
                -o "$DOWNLOAD_PATH" \
                --progress-bar \
                --retry 3 \
                --retry-delay 5; then
              echo "âœ… Download completed successfully"
              break
            else
              echo "âš ï¸ Download attempt $attempt failed"
              if [ $attempt -eq 3 ]; then
                echo "âŒ All download attempts failed"
                exit 1
              fi
              sleep 10
            fi
          done
          
          # Verify download
          if [ -f "$DOWNLOAD_PATH" ]; then
            FILE_SIZE=$(ls -lh "$DOWNLOAD_PATH" | awk '{print $5}')
            echo "Downloaded file size: $FILE_SIZE"
            
            # Check if file is a valid zip
            if file "$DOWNLOAD_PATH" | grep -q "Zip archive data"; then
              echo "âœ… File is a valid ZIP archive"
            else
              echo "âš ï¸ File may not be a valid ZIP archive"
            fi
          else
            echo "âŒ Download file not found"
            exit 1
          fi

      - name: Extract RealVNC Installer
        run: |
          echo "=== Extracting RealVNC Installer ==="
          
          # Create extraction directory
          mkdir -p "$EXTRACT_PATH"
          
          # Extract the zip file
          echo "Extracting to: $EXTRACT_PATH"
          if unzip -q "$DOWNLOAD_PATH" -d "$EXTRACT_PATH"; then
            echo "âœ… Extraction successful"
          else
            echo "âŒ Extraction failed"
            exit 1
          fi
          
          # List extracted contents
          echo ""
          echo "=== Extracted Contents ==="
          find "$EXTRACT_PATH" -type f -name "*.app" -o -name "*.pkg" -o -name "*.dmg" | while read file; do
            echo "- $(basename "$file")"
          done
          
          # Find the main installer app
          INSTALLER_APP=$(find "$EXTRACT_PATH" -name "*.app" -type d | head -1)
          if [ -n "$INSTALLER_APP" ]; then
            echo "Found installer: $INSTALLER_APP"
            echo "INSTALLER_APP=$INSTALLER_APP" >> $GITHUB_ENV
          else
            echo "âŒ No .app file found in extracted contents"
            exit 1
          fi

      - name: Take Pre-Installation Screenshot
        run: |
          echo "=== Taking Pre-Installation Screenshot ==="
          
          timestamp=$(date +%Y%m%d_%H%M%S)
          screenshot_file="$SCREENSHOT_DIR/pre_install_$timestamp.png"
          
          screencapture -x "$screenshot_file"
          
          if [ -f "$screenshot_file" ]; then
            filesize=$(ls -lh "$screenshot_file" | awk '{print $5}')
            echo "âœ… Pre-installation screenshot saved: $(basename $screenshot_file) ($filesize)"
          else
            echo "âš ï¸ Failed to take pre-installation screenshot"
          fi

      - name: Install RealVNC Connect
        run: |
          echo "=== Installing RealVNC Connect ==="
          
          # Check if installer exists
          if [ ! -d "$INSTALLER_APP" ]; then
            echo "âŒ Installer app not found: $INSTALLER_APP"
            exit 1
          fi
          
          echo "Installer path: $INSTALLER_APP"
          echo "Installer name: $(basename "$INSTALLER_APP")"
          
          # Get app name (remove .app extension if present)
          APP_NAME=$(basename "$INSTALLER_APP" .app)
          echo "App name: $APP_NAME"
          
          # Take screenshot before installation
          before_install="$SCREENSHOT_DIR/before_install_$(date +%H%M%S).png"
          screencapture -x "$before_install"
          
          # Method 1: Try to open the installer
          echo "Opening installer..."
          open "$INSTALLER_APP"
          
          # Wait for installer to appear
          echo "Waiting for installer to launch..."
          for i in {1..30}; do
            if pgrep -f "$APP_NAME" > /dev/null || osascript -e "application \"$APP_NAME\" is running" 2>/dev/null; then
              echo "âœ… Installer launched (attempt $i)"
              break
            fi
            sleep 1
          done
          
          # Give more time for UI to appear
          sleep 5
          
          # Take screenshot of installer
          installer_screen="$SCREENSHOT_DIR/installer_ui_$(date +%H%M%S).png"
          screencapture -x "$installer_screen"
          
          # Method 2: If it's a .app bundle, we might need to run it differently
          echo "Checking installer type..."
          
          # Look for PKG files inside the app bundle
          PKG_FILES=$(find "$INSTALLER_APP" -name "*.pkg" -type f 2>/dev/null)
          if [ -n "$PKG_FILES" ]; then
            echo "Found PKG files inside app bundle:"
            echo "$PKG_FILES"
            
            # Try to install the first PKG found
            FIRST_PKG=$(echo "$PKG_FILES" | head -1)
            echo "Attempting to install PKG: $FIRST_PKG"
            
            # Take screenshot before PKG installation
            before_pkg="$SCREENSHOT_DIR/before_pkg_install_$(date +%H%M%S).png"
            screencapture -x "$before_pkg"
            
            # Try silent installation if possible
            echo "Attempting PKG installation..."
            sudo installer -pkg "$FIRST_PKG" -target / 2>&1 | tee "$LOG_DIR/pkg_install.log" || echo "PKG installation may require GUI"
          fi
          
          # Check for DMG files
          DMG_FILES=$(find "$EXTRACT_PATH" -name "*.dmg" -type f 2>/dev/null)
          if [ -n "$DMG_FILES" ]; then
            echo "Found DMG files:"
            echo "$DMG_FILES"
            
            FIRST_DMG=$(echo "$DMG_FILES" | head -1)
            echo "Mounting DMG: $FIRST_DMG"
            
            # Mount the DMG
            hdiutil attach "$FIRST_DMG" -nobrowse 2>&1 | tee "$LOG_DIR/dmg_mount.log"
            
            # Find apps in mounted volume
            VOLUME_PATH=$(hdiutil attach "$FIRST_DMG" -nobrowse | tail -1 | awk '{$1=$2=""; print $0}' | xargs)
            echo "Mounted at: $VOLUME_PATH"
            
            # Look for app in mounted volume
            find "$VOLUME_PATH" -name "*.app" -type d | while read app_path; do
              echo "Found app in DMG: $app_path"
              
              # Copy to Applications
              echo "Copying to Applications..."
              cp -R "$app_path" "/Applications/" 2>&1 | tee -a "$LOG_DIR/app_copy.log"
            done
            
            # Unmount when done
            hdiutil detach "$VOLUME_PATH" 2>&1 | tee -a "$LOG_DIR/dmg_unmount.log"
          fi
          
          # Wait for any installation to complete
          sleep 10
          
          # Take screenshot after installation attempt
          after_install="$SCREENSHOT_DIR/after_install_$(date +%H%M%S).png"
          screencapture -x "$after_install"
          
          echo "âœ… Installation process completed"

      - name: Launch RealVNC Connect
        run: |
          echo "=== Launching RealVNC Connect ==="
          
          # Find RealVNC Connect in Applications
          VNC_APPS=(
            "/Applications/RealVNC Connect.app"
            "/Applications/RealVNC Connect/RealVNC Connect.app"
            "/Applications/VNC Connect.app"
            "/Applications/VNC-Server.app"
            "/Applications/VNC-Viewer.app"
          )
          
          VNC_APP=""
          for app in "${VNC_APPS[@]}"; do
            if [ -d "$app" ]; then
              VNC_APP="$app"
              echo "Found RealVNC app at: $VNC_APP"
              break
            fi
          done
          
          if [ -z "$VNC_APP" ]; then
            # Search for any VNC-related app
            echo "Searching for VNC apps..."
            VNC_APP=$(find /Applications -name "*VNC*" -type d -maxdepth 2 2>/dev/null | head -1)
            if [ -n "$VNC_APP" ]; then
              echo "Found VNC app via search: $VNC_APP"
            else
              echo "âŒ No VNC app found in Applications"
              exit 1
            fi
          fi
          
          # Take screenshot before launch
          before_launch="$SCREENSHOT_DIR/before_launch_$(date +%H%M%S).png"
          screencapture -x "$before_launch"
          
          # Launch the app
          echo "Launching: $VNC_APP"
          open -a "$VNC_APP"
          
          # Wait for app to launch
          echo "Waiting for RealVNC Connect to start..."
          for i in {1..30}; do
            APP_PROCESS=$(basename "$VNC_APP" .app)
            if pgrep -f "$APP_PROCESS" > /dev/null; then
              echo "âœ… RealVNC Connect launched (attempt $i)"
              break
            fi
            sleep 1
          done
          
          # Give time for UI to appear
          sleep 8
          
          # Take screenshot after launch
          after_launch="$SCREENSHOT_DIR/after_launch_$(date +%H%M%S).png"
          screencapture -x "$after_launch"
          
          # Store app info for later use
          echo "VNC_APP=$VNC_APP" >> $GITHUB_ENV
          echo "VNC_PROCESS=$(basename "$VNC_APP" .app)" >> $GITHUB_ENV

      - name: Interact with RealVNC UI
        run: |
          echo "=== Interacting with RealVNC UI ==="
          
          # Take screenshot before interaction
          before_interact="$SCREENSHOT_DIR/before_interaction_$(date +%H%M%S).png"
          screencapture -x "$before_interact"
          
          # Try to interact with the UI using AppleScript
          echo "Attempting to interact with RealVNC UI..."
          
          # First, let's see what windows are available
          osascript <<'EOF' 2>&1 | tee "$LOG_DIR/window_info.log"
          tell application "System Events"
            try
              tell process "$VNC_PROCESS"
                set windowNames to name of every window
                return "Available windows: " & windowNames
              end tell
            on error errMsg
              return "Error getting windows: " & errMsg
            end try
          end tell
          EOF
          
          # Try to click common UI elements
          echo "Attempting to click UI elements..."
          
          # Common RealVNC UI elements to try
          osascript <<'EOF' 2>&1 | tee "$LOG_DIR/ui_interaction.log"
          tell application "System Events"
            try
              tell process "$VNC_PROCESS"
                -- Try to find and click buttons
                set allButtons to buttons of window 1
                repeat with i from 1 to count of allButtons
                  try
                    set btn to item i of allButtons
                    set btnName to name of btn
                    if btnName is not "" then
                      log "Found button: " & btnName
                      -- Try clicking common buttons
                      if btnName contains "Connect" or btnName contains "Start" or btnName contains "OK" or btnName contains "Continue" then
                        click btn
                        log "Clicked button: " & btnName
                        delay 1
                      end if
                    end if
                  end try
                end repeat
                
                -- Try to find text fields
                set allFields to text fields of window 1
                repeat with i from 1 to count of allFields
                  try
                    set field to item i of allFields
                    set fieldValue to value of field
                    log "Found text field with value: " & fieldValue
                  end try
                end repeat
                
                return "UI interaction attempted"
              end tell
            on error errMsg
              return "UI interaction error: " & errMsg
            end try
          end tell
          EOF
          
          # Wait for UI to update
          sleep 5
          
          # Take screenshot after interaction
          after_interact="$SCREENSHOT_DIR/after_interaction_$(date +%H%M%S).png"
          screencapture -x "$after_interact"
          
          echo "âœ… UI interaction completed"

      - name: Take Multiple Screenshots
        run: |
          echo "=== Taking Multiple Screenshots ==="
          
          # Take 5 screenshots with delays
          for i in {1..5}; do
            echo ""
            echo "ðŸ“¸ Taking screenshot $i/5..."
            
            timestamp=$(date +%Y%m%d_%H%M%S)
            filepath="$SCREENSHOT_DIR/screenshot_${i}_${timestamp}.png"
            
            screencapture -x "$filepath"
            
            if [ -f "$filepath" ]; then
              filesize=$(ls -lh "$filepath" | awk '{print $5}')
              echo "âœ… Saved: $(basename $filepath) ($filesize)"
            else
              echo "âš ï¸ Failed to take screenshot $i"
            fi
            
            if [ $i -lt 5 ]; then
              echo "   Waiting 3 seconds..."
              sleep 3
            fi
          done
          
          # List all screenshots
          echo ""
          echo "=== All Screenshots ==="
          ls -la "$SCREENSHOT_DIR/"*.png 2>/dev/null | awk '{print $5, $9}' | while read line; do
            echo "- $line"
          done

      - name: Gather System Information
        run: |
          echo "=== Gathering System Information ==="
          
          INFO_FILE="$LOG_DIR/system_info.txt"
          
          echo "RealVNC Connect Test Report" > "$INFO_FILE"
          echo "=============================" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          echo "Test Date: $(date)" >> "$INFO_FILE"
          echo "macOS Version: $(sw_vers -productVersion)" >> "$INFO_FILE"
          echo "RealVNC Version: $VNC_VERSION" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          echo "=== Installation Details ===" >> "$INFO_FILE"
          echo "Download URL: $DOWNLOAD_URL" >> "$INFO_FILE"
          echo "Installer Path: $INSTALLER_APP" >> "$INFO_FILE"
          if [ -n "$VNC_APP" ]; then
            echo "Installed App: $VNC_APP" >> "$INFO_FILE"
          fi
          echo "" >> "$INFO_FILE"
          
          echo "=== Running Processes ===" >> "$INFO_FILE"
          pgrep -f "VNC" >> "$INFO_FILE" || echo "No VNC processes found" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          echo "=== Installed Applications ===" >> "$INFO_FILE"
          find /Applications -name "*VNC*" -type d -maxdepth 2 2>/dev/null >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          echo "=== Screenshots Taken ===" >> "$INFO_FILE"
          find "$SCREENSHOT_DIR" -name "*.png" -type f -exec basename {} \; >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          echo "=== Disk Usage ===" >> "$INFO_FILE"
          du -sh "$EXTRACT_PATH" 2>/dev/null >> "$INFO_FILE" || echo "Extract path not found" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          # Display the info
          cat "$INFO_FILE"

      - name: Upload Screenshots and Logs
        uses: actions/upload-artifact@v4
        with:
          name: realvnc-screenshots-logs
          path: |
            ${{ env.SCREENSHOT_DIR }}
            ${{ env.LOG_DIR }}
            ${{ env.DOWNLOAD_PATH }}
          retention-days: 7

      - name: Upload Installation Report
        uses: actions/upload-artifact@v4
        with:
          name: realvnc-installation-report
          path: |
            ${{ env.LOG_DIR }}/system_info.txt
            ${{ env.LOG_DIR }}/*.log
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          echo "=== Performing Cleanup ==="
          
          # Take final screenshot
          final_screenshot="$SCREENSHOT_DIR/final_$(date +%H%M%S).png"
          screencapture -x "$final_screenshot" 2>/dev/null && echo "âœ… Final screenshot taken" || echo "âš ï¸ Could not take final screenshot"
          
          # Quit RealVNC if running
          if [ -n "$VNC_PROCESS" ]; then
            echo "Quitting RealVNC Connect..."
            osascript -e "tell application \"$VNC_PROCESS\" to quit" 2>/dev/null || true
            sleep 2
            pkill -f "$VNC_PROCESS" 2>/dev/null || true
          fi
          
          # Unmount any DMG volumes
          echo "Unmounting any DMG volumes..."
          hdiutil detach /Volumes/*VNC* 2>/dev/null || true
          hdiutil detach /Volumes/*RealVNC* 2>/dev/null || true
          
          # Remove temporary files (keep for artifact upload)
          echo "Cleanup completed"
          echo "Total screenshots: $(find "$SCREENSHOT_DIR" -name "*.png" 2>/dev/null | wc -l)"
          echo "Total log files: $(find "$LOG_DIR" -name "*.log" 2>/dev/null | wc -l)"
