name: Rustdesk with Sunshine + VNC

on:
  workflow_dispatch:

env:
  SSHX_SESSION_FILE: /tmp/sshx_session.log
  SSHX_PID: 0

jobs:
  setup-sshx:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours total

    steps:
      - name: Install dependencies
        run: |
          echo "=== Installing basic dependencies ==="
          sudo apt-get update
          sudo apt-get install -y curl wget
          echo "âœ… Dependencies installed"

      - name: Install sshx and show URL
        run: |
          echo "=== Installing sshx ==="
          curl -sSf https://sshx.io/get | sh
          
          echo ""
          echo "=== Starting sshx session ==="
          
          # Run sshx and capture output to file
          sshx 2>&1 | tee "$SSHX_SESSION_FILE" &
          SSHX_PID=$!
          echo "SSHX_PID=$SSHX_PID" >> $GITHUB_ENV
          
          # Wait for sshx to start
          sleep 10
          
          # Check if sshx is running
          if ps -p $SSHX_PID > /dev/null 2>&1; then
            echo "âœ… sshx running with PID: $SSHX_PID"
          else
            echo "âš ï¸ sshx may have exited"
          fi
          
          # Extract and show the sshx URL
          echo ""
          echo "=== SSHX Connection URL ==="
          if [ -f "$SSHX_SESSION_FILE" ]; then
            # Look for the sshx.io URL in the output
            SSHX_URL=$(grep -o "https://sshx.io/[a-zA-Z0-9-]\+" "$SSHX_SESSION_FILE" | head -1 || true)
            if [ ! -z "$SSHX_URL" ]; then
              echo "ðŸ”— Connect via: $SSHX_URL"
              echo "SSHX_URL=$SSHX_URL" >> $GITHUB_ENV
            else
              echo "âš ï¸ Could not extract SSHX URL from logs"
              echo "=== Last 10 lines of sshx output ==="
              tail -10 "$SSHX_SESSION_FILE" || true
            fi
          fi

      - name: Install Ubuntu Desktop and required packages
        run: |
          echo "=== Installing required packages ==="
          
          # Disable Wayland and force X11
          sudo tee /etc/gdm3/custom.conf > /dev/null << 'EOF'
          [daemon]
          WaylandEnable=false
          DefaultSession=gnome-xorg.desktop
          EOF
          
          # Update and install required packages
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            ubuntu-desktop \
            xorg \
            xserver-xorg-core \
            xserver-xorg-video-dummy \
            xserver-xorg-input-void \
            xinit \
            x11-xserver-utils \
            x11vnc \
            dbus-x11 \
            pulseaudio \
            mesa-utils \
            libgl1-mesa-dri \
            libgl1-mesa-glx \
            gnome-shell \
            gnome-session \
            gdm3
            
          echo "âœ… Packages installed"

      - name: Configure X11 dummy display
        run: |
          echo "=== Configuring X11 dummy display ==="
          
          # Create X11 configuration for dummy display
          sudo tee /etc/X11/xorg.conf > /dev/null << 'EOF'
          Section "Device"
            Identifier "DummyDevice"
            Driver "dummy"
            VideoRam 256000
            Option "IgnoreEDID" "true"
            Option "NoDDC" "true"
          EndSection

          Section "Monitor"
            Identifier "DummyMonitor"
            HorizSync 28.0-80.0
            VertRefresh 48.0-75.0
            Modeline "1920x1080" 172.80 1920 2040 2248 2576 1080 1081 1084 1118
          EndSection

          Section "Screen"
            Identifier "DummyScreen"
            Device "DummyDevice"
            Monitor "DummyMonitor"
            DefaultDepth 24
            SubSection "Display"
              Depth 24
              Modes "1920x1080"
            EndSubSection
          EndSection

          Section "ServerLayout"
            Identifier "DefaultLayout"
            Screen "DummyScreen"
            InputDevice "VoidMouse"
            InputDevice "VoidKeyboard"
          EndSection

          Section "InputDevice"
            Identifier "VoidMouse"
            Driver "void"
          EndSection

          Section "InputDevice"
            Identifier "VoidKeyboard"
            Driver "void"
          EndSection
          EOF
          
          echo "âœ… X11 dummy display configured"

      - name: Setup user groups and permissions for Sunshine
        run: |
          echo "=== Setting up Sunshine permissions ==="
          
          # Create required groups if they don't exist
          sudo groupadd -f input
          sudo groupadd -f render
          sudo groupadd -f video
          
          # Add user to required groups
          sudo usermod -aG input,render,video,audio,tty,dialout $(whoami)
          
          # Configure udev rules for uinput
          sudo tee /etc/udev/rules.d/60-uinput.rules > /dev/null << 'EOF'
          KERNEL=="uinput", MODE="0660", GROUP="input", OPTIONS+="static_node=uinput"
          KERNEL=="event*", SUBSYSTEM=="input", MODE="0660", GROUP="input"
          KERNEL=="mice", SUBSYSTEM=="input", MODE="0660", GROUP="input"
          KERNEL=="mouse*", SUBSYSTEM=="input", MODE="0660", GROUP="input"
          EOF
          
          # Configure render group permissions for GPU
          sudo tee /etc/udev/rules.d/70-render.rules > /dev/null << 'EOF'
          KERNEL=="renderD*", GROUP="render", MODE="0660"
          EOF
          
          # Reload udev rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger
          
          # Create necessary runtime directories
          sudo mkdir -p /tmp/runtime-root
          sudo chmod 700 /tmp/runtime-root
          
          echo "âœ… Permissions configured"

      - name: Install Tailscale
        run: |
          echo "=== Installing Tailscale ==="
          
          # Install Tailscale
          curl -fsSL https://tailscale.com/install.sh | sh
          
          # Start Tailscale with auth key
          sudo tailscale up --auth-key "tskey-auth-katBTfGaCP11CNTRL-hMqSUZh4fgPZNHebqNt7gPCxLc3sP2pf" --hostname "github-runner-$(date +%s)" --accept-routes --accept-dns &
          
          echo "âœ… Tailscale installed and connecting in background"
          
          # Wait a bit for connection
          sleep 15
          
          # Show Tailscale status
          echo "=== Tailscale Status ==="
          sudo tailscale status || true

      - name: Install Sunshine
        run: |
          echo "=== Installing Sunshine ==="
          
          # Download Sunshine
          SUNSHINE_URL="https://github.com/LizardByte/Sunshine/releases/download/v2025.924.154138/sunshine-ubuntu-24.04-amd64.deb"
          SUNSHINE_DEB="sunshine.deb"
          
          echo "Downloading Sunshine from: $SUNSHINE_URL"
          wget -O "$SUNSHINE_DEB" "$SUNSHINE_URL"
          
          echo "Installing Sunshine..."
          sudo apt install -y "./$SUNSHINE_DEB"
          
          echo "âœ… Sunshine installed"

      - name: Start Xorg server and GNOME session
        run: |
          echo "=== Starting Xorg server and GNOME ==="
          
          # Kill any existing X servers
          pkill Xorg 2>/dev/null || true
          sleep 2
          
          # Set display environment
          export DISPLAY=:0
          export XDG_RUNTIME_DIR=/tmp/runtime-root
          export XAUTHORITY=/tmp/.Xauthority
          
          # Create .xinitrc for GNOME session
          echo 'exec dbus-launch --exit-with-session gnome-session' > ~/.xinitrc
          chmod +x ~/.xinitrc
          
          # Start Xorg on vt1 (virtual terminal 1)
          echo "Starting Xorg on :0..."
          sudo Xorg :0 vt1 -nolisten tcp -noreset -auth /tmp/.Xauthority &
          XORG_PID=$!
          echo "XORG_PID=$XORG_PID" >> $GITHUB_ENV
          
          # Wait for X server to start
          sleep 8
          
          # Set display for this session
          echo "DISPLAY=:0" >> $GITHUB_ENV
          echo "XAUTHORITY=/tmp/.Xauthority" >> $GITHUB_ENV
          
          # Verify X is running
          if xhost >/dev/null 2>&1; then
            echo "âœ… X server is running on display :0"
          else
            echo "âŒ X server failed to start"
            # Try alternative method
            echo "Attempting alternative X startup..."
            startx -- :0 &
            sleep 10
          fi
          
          # Start GNOME session
          echo "Starting GNOME session..."
          export DISPLAY=:0
          export XAUTHORITY=/tmp/.Xauthority
          dbus-launch --exit-with-session gnome-session &
          GNOME_PID=$!
          echo "GNOME_PID=$GNOME_PID" >> $GITHUB_ENV
          
          sleep 15
          
          # Set GNOME settings for remote access
          export DISPLAY=:0
          export XAUTHORITY=/tmp/.Xauthority
          gsettings set org.gnome.desktop.screensaver lock-enabled false
          gsettings set org.gnome.desktop.session idle-delay 0
          gsettings set org.gnome.desktop.lockdown disable-lock-screen true
          
          echo "âœ… GNOME session started"

      - name: Start VNC server
        run: |
          echo "=== Starting VNC server ==="
          
          # Kill any existing VNC servers
          pkill x11vnc 2>/dev/null || true
          sleep 2
          
          # Start VNC server
          export DISPLAY=:0
          export XAUTHORITY=/tmp/.Xauthority
          
          echo "Starting x11vnc..."
          x11vnc -display :0 -forever -shared -rfbport 5900 -bg -noxdamage -passwd sunshine123 &
          VNC_PID=$!
          echo "VNC_PID=$VNC_PID" >> $GITHUB_ENV
          
          sleep 3
          echo "âœ… VNC server running on port 5900"
          echo "VNC Password: sunshine123"

      - name: Start Sunshine with proper configuration
        run: |
          echo "=== Starting Sunshine ==="
          
          # Kill any existing Sunshine processes
          pkill -f "sunshine" 2>/dev/null || true
          sleep 2
          
          # Set environment variables for Sunshine
          export DISPLAY=:0
          export XAUTHORITY=/tmp/.Xauthority
          export WAYLAND_DISPLAY=""
          
          # Create Sunshine configuration directory
          mkdir -p ~/.config/sunshine
          
          # Create basic Sunshine configuration
          cat > ~/.config/sunshine/sunshine.conf << 'EOF'
          # Sunshine Configuration
          sunshine_name=GitHub Runner
          
          # Port configuration
          sunshine_port=47989
          sunshine_http_port=47990
          
          # Video settings
          fps=60
          min_threads=1
          hevc_mode=0
          
          # Input settings
          key_rightalt_to_key_win=1
          
          # Encoder settings
          encoder=software
          
          # Audio settings
          audio_sink=auto
          
          # Gamepad settings
          gamepad=ds4
          EOF
          
          # Start Sunshine
          echo "Starting Sunshine..."
          sunshine &
          SUNSHINE_PID=$!
          echo "SUNSHINE_PID=$SUNSHINE_PID" >> $GITHUB_ENV
          
          # Wait for Sunshine to start
          sleep 10
          
          echo "âœ… Sunshine started"
          echo "Sunshine Web UI: https://localhost:47990"
          echo "Default credentials: sunshine/sunshine"
          
          # Try to access Sunshine web UI to create credentials
          if curl -s -k https://localhost:47990 >/dev/null 2>&1; then
            echo "Sunshine web UI is accessible"
          else
            echo "Note: Sunshine web UI might take a moment to become accessible"
          fi

      - name: Keep SSHX alive for 6 hours
        run: |
          echo "=== SSHX Remote Access Active ==="
          echo ""
          echo "Start time: $(date)"
          echo "Will keep alive until: $(date -d '+6 hours')"
          echo ""
          
          # Set environment
          export DISPLAY=:0
          export XAUTHORITY=/tmp/.Xauthority
          
          # Display SSHX connection info
          if [ -f "$SSHX_SESSION_FILE" ]; then
            echo "=== SSHX Session Information ==="
            SSHX_URL=$(grep -o "https://sshx.io/[a-zA-Z0-9-]\+" "$SSHX_SESSION_FILE" | head -1 || true)
            if [ ! -z "$SSHX_URL" ]; then
              echo "ðŸ”— SSHX Connection URL: $SSHX_URL"
            else
              echo "âš ï¸ SSHX URL not found in logs"
            fi
            echo ""
          fi
          
          # Display Tailscale IP if connected
          echo "=== Tailscale Status ==="
          sudo tailscale ip 2>/dev/null | head -1 | while read ip; do
            echo "ðŸŒ Tailscale IP: $ip"
            echo "ðŸŒ Sunshine via Tailscale: https://$ip:47990"
            echo "ðŸŒ VNC via Tailscale: $ip:5900"
          done || echo "Tailscale IP not available"
          echo ""
          
          # Display connection info
          echo "=== Sunshine Information ==="
          echo "ðŸŒž Sunshine Web Interface: https://localhost:47990"
          echo "ðŸŒž Sunshine Streaming Port: 47989"
          echo "ðŸŒž Default credentials: sunshine/sunshine"
          echo ""
          echo "=== VNC Information (fallback) ==="
          echo "ðŸ–¥ï¸  VNC Server: port 5900"
          echo "ðŸ”‘ VNC Password: sunshine123"
          echo ""
          
          # Keep alive for 6 hours (360 minutes)
          TOTAL_MINUTES=360
          for minute in $(seq 1 $TOTAL_MINUTES); do
            echo "=== Minute $minute/$TOTAL_MINUTES ==="
            echo "Time: $(date)"
            echo "Elapsed: $((minute / 60))h $((minute % 60))m"
            echo "Remaining: $(((TOTAL_MINUTES - minute) / 60))h $(((TOTAL_MINUTES - minute) % 60))m"
            
            # Check if sshx is running
            if [ ! -z "$SSHX_PID" ] && ps -p $SSHX_PID > /dev/null 2>&1; then
              echo "âœ… sshx: Running (PID: $SSHX_PID)"
            else
              echo "âŒ sshx: Not running, attempting to restart..."
              # Kill any remaining sshx processes
              pkill -f "sshx" 2>/dev/null || true
              sleep 2
              # Restart sshx
              sshx 2>&1 | tee -a "$SSHX_SESSION_FILE" &
              SSHX_PID=$!
              echo "New PID: $SSHX_PID"
              echo "SSHX_PID=$SSHX_PID" >> $GITHUB_ENV
              sleep 10
            fi
            
            # Check other services every 5 minutes
            if [ $((minute % 5)) -eq 0 ]; then
              echo "=== Service Status Check ==="
              
              # Check X server
              if ps -p $XORG_PID > /dev/null 2>&1; then
                if xhost >/dev/null 2>&1; then
                  echo "âœ… X Server: Running (PID: $XORG_PID, Display: :0)"
                else
                  echo "âš ï¸ X Server: Process exists but display not responding"
                  echo "Restarting X server..."
                  pkill Xorg 2>/dev/null || true
                  sleep 2
                  sudo Xorg :0 vt1 -nolisten tcp -noreset -auth /tmp/.Xauthority &
                  XORG_PID=$!
                  echo "XORG_PID=$XORG_PID" >> $GITHUB_ENV
                  sleep 8
                fi
              else
                echo "âŒ X Server: Not running, restarting..."
                sudo Xorg :0 vt1 -nolisten tcp -noreset -auth /tmp/.Xauthority &
                XORG_PID=$!
                echo "XORG_PID=$XORG_PID" >> $GITHUB_ENV
                sleep 8
              fi
              
              # Check Sunshine
              if ps -p $SUNSHINE_PID > /dev/null 2>&1; then
                echo "âœ… Sunshine: Running (PID: $SUNSHINE_PID)"
                # Check if Sunshine web UI is responding
                if curl -s -k https://localhost:47990 >/dev/null 2>&1; then
                  echo "   Web UI: Accessible"
                else
                  echo "   Web UI: Not responding"
                fi
              else
                echo "âš ï¸ Sunshine: Not running, restarting..."
                pkill -f "sunshine" 2>/dev/null || true
                sleep 2
                export DISPLAY=:0
                export XAUTHORITY=/tmp/.Xauthority
                sunshine &
                SUNSHINE_PID=$!
                echo "SUNSHINE_PID=$SUNSHINE_PID" >> $GITHUB_ENV
                sleep 10
              fi
              
              # Check Tailscale
              if sudo tailscale status 2>/dev/null | grep -q "active"; then
                echo "âœ… Tailscale: Connected"
                # Show Tailscale IP
                TAILSCALE_IP=$(sudo tailscale ip 2>/dev/null | head -1 || echo "")
                if [ ! -z "$TAILSCALE_IP" ]; then
                  echo "   IP Address: $TAILSCALE_IP"
                  echo "   Sunshine via Tailscale: https://$TAILSCALE_IP:47990"
                  echo "   VNC via Tailscale: $TAILSCALE_IP:5900"
                fi
              else
                echo "âš ï¸ Tailscale: Not connected, attempting restart..."
                sudo tailscale up --auth-key "tskey-auth-katBTfGaCP11CNTRL-hMqSUZh4fgPZNHebqNt7gPCxLc3sP2pf" --reset || true
              fi
            fi
            
            # Wait for next minute
            if [ $minute -lt $TOTAL_MINUTES ]; then
              echo "â³ Waiting 60 seconds..."
              sleep 60
            fi
          done
          
          echo ""
          echo "âœ… 6 hours complete. Session ending."

      - name: Cleanup
        if: always()
        run: |
          echo "=== Cleaning up ==="
          
          # Kill sshx process
          if [ ! -z "$SSHX_PID" ] && ps -p $SSHX_PID > /dev/null 2>&1; then
            echo "Stopping sshx (PID: $SSHX_PID)..."
            kill $SSHX_PID 2>/dev/null || true
            sleep 2
          fi
          
          # Kill any other sshx processes
          pkill -f "sshx" 2>/dev/null || true
          
          # Kill Sunshine
          echo "Stopping Sunshine..."
          pkill -f "sunshine" 2>/dev/null || true
          
          # Kill VNC
          echo "Stopping VNC..."
          pkill -f "x11vnc" 2>/dev/null || true
          
          # Kill GNOME session
          echo "Stopping GNOME session..."
          pkill -f "gnome-session" 2>/dev/null || true
          
          # Kill X server
          echo "Stopping X server..."
          pkill Xorg 2>/dev/null || true
          
          # Stop Tailscale
          echo "Stopping Tailscale..."
          sudo tailscale down 2>/dev/null || true
          
          echo "âœ… Cleanup complete"
