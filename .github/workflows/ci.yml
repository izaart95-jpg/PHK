name: Parsec AutoHotkey Automation

on:
  workflow_dispatch:

jobs:
  parsec-ahk-automation:
    runs-on: windows-latest
    timeout-minutes: 360  # 6 hours

    steps:
      - name: Create working directory
        shell: powershell
        run: |
          $workDir = "$env:GITHUB_WORKSPACE\parsec-automation"
          $screenshotDir = "$env:GITHUB_WORKSPACE\screenshots"
          New-Item -ItemType Directory -Path $workDir -Force
          New-Item -ItemType Directory -Path $screenshotDir -Force
          Set-Location $workDir
          echo "WORK_DIR=$workDir" >> $env:GITHUB_ENV
          echo "SCREENSHOT_DIR=$screenshotDir" >> $env:GITHUB_ENV

      - name: Download and install NirCmd
        shell: powershell
        run: |
          $nircmdUrl = "https://www.nirsoft.net/utils/nircmd-x64.zip"
          $nircmdZip = "$env:WORK_DIR\nircmd.zip"
          $nircmdDir = "$env:WORK_DIR\nircmd"
          
          # Download NirCmd
          Invoke-WebRequest -Uri $nircmdUrl -OutFile $nircmdZip -UserAgent "Mozilla/5.0"
          
          # Extract NirCmd
          Expand-Archive -Path $nircmdZip -DestinationPath $nircmdDir -Force
          
          $nircmdPath = "$nircmdDir\nircmd.exe"
          echo "NIRCMD_PATH=$nircmdPath" >> $env:GITHUB_ENV
          Write-Host "NirCmd installed at: $nircmdPath"

      - name: Download and install AutoHotkey v2
        shell: powershell
        run: |
          $ahkUrl = "https://download1532.mediafire.com/b2tq21p9107gms-k4vnD6bn3k7M902vy5S_DuEF3GtbJBBoEXwoPU3aPS0ss4AsReX7Ia-9jtHqDKhVK2iZs6TzEwDC-4sR4zbfe7FT0eqIPCav_T1Hkdj0Bmli1vVzU2cFm4IkTcmaepV04qN5LFK6H2w9kQkGzgXfCDeo-q9tGqmc/tob6736a61vcdph/AutoHotkey_2.0.19_setup.exe"
          $ahkPath = "$env:WORK_DIR\ahk-v2.exe"
          Invoke-WebRequest -Uri $ahkUrl -OutFile $ahkPath
          Start-Process -FilePath $ahkPath -ArgumentList "/silent" -Wait
          echo "AutoHotkey installed"

      - name: Download AutoHotkey script
        shell: powershell
        run: |
          $scriptUrl = "https://download1324.mediafire.com/wl4maomsy7zgrw7Zb3L_XP0WSGurFboLAPv9RJV3Zg0V6XDqMoo9wAKPaFE9aDMjTNLtL72qPxB5OSuXSEUZbALIThPG0hNpWiMcCzylNZAUjR9f_WCv_rguJ9Ei-wnd9LxvDa_IP8OjZY5AEv94FJYz-lyUA6amzFeVouLoi80-naQ/dia57ollssbenug/scri%27%2B%27pt.ahk"
          $scriptPath = "$env:WORK_DIR\script.ahk"
          Invoke-WebRequest -Uri $scriptUrl -OutFile $scriptPath
          echo "AHK_SCRIPT_PATH=$scriptPath" >> $env:GITHUB_ENV
          Write-Host "Downloaded AHK script to: $scriptPath"

      - name: Download and install Parsec
        shell: powershell
        run: |
          $parsecUrl = "https://builds.parsec.app/package/parsec-windows.exe"
          $parsecPath = "$env:WORK_DIR\parsec-windows.exe"
          Invoke-WebRequest -Uri $parsecUrl -OutFile $parsecPath
          Start-Process -FilePath $parsecPath -ArgumentList "/S" -Wait
          Start-Sleep -Seconds 20
          echo "Parsec installed"

      - name: Create screenshot script
        shell: powershell
        run: |
          $screenshotScript = @'
          param(
              [string]$NircmdPath,
              [string]$ScreenshotDir,
              [int]$IntervalSeconds = 30,
              [int]$MaxScreenshots = 720  # 6 hours * 120 screenshots/hour
          )
          
          $count = 0
          while ($count -lt $MaxScreenshots) {
              $timestamp = Get-Date -Format "yyyy-MM-dd_HH-mm-ss"
              $filename = "$ScreenshotDir\screenshot_$($count.ToString('D4'))_$timestamp.png"
              
              # Take screenshot using NirCmd
              & $NircmdPath savescreenshot $filename
              
              Write-Host "[$(Get-Date)] Screenshot saved: $filename"
              $count++
              
              Start-Sleep -Seconds $IntervalSeconds
          }
          '@
          
          $scriptPath = "$env:WORK_DIR\take_screenshots.ps1"
          $screenshotScript | Out-File -FilePath $scriptPath -Encoding UTF8
          echo "SCREENSHOT_SCRIPT=$scriptPath" >> $env:GITHUB_ENV
          Write-Host "Screenshot script created at: $scriptPath"

      - name: Run AutoHotkey script and start screenshots
        shell: powershell
        run: |
          $ahkUX = "C:\Program Files\AutoHotkey\UX\AutoHotkeyUX.exe"
          $ahkV2 = "C:\Program Files\AutoHotkey\v2\AutoHotkey.exe"
          
          # Start Parsec first
          Start-Process "parsec:" -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 5
          
          # Start AutoHotkey script
          if (Test-Path $ahkUX) {
              Start-Process -FilePath $ahkUX -ArgumentList "`"$env:AHK_SCRIPT_PATH`""
              Write-Host "Started AHK using UX launcher"
          }
          elseif (Test-Path $ahkV2) {
              Start-Process -FilePath $ahkV2 -ArgumentList "`"$env:AHK_SCRIPT_PATH`""
              Write-Host "Started AHK using v2 directly"
          }
          else {
              Write-Host "AutoHotkey NOT FOUND!"
          }
          
          Write-Host "AutoHotkey script started"
          
          # Take initial screenshot immediately
          $timestamp = Get-Date -Format "yyyy-MM-dd_HH-mm-ss"
          $initialScreenshot = "$env:SCREENSHOT_DIR\screenshot_0000_INITIAL_$timestamp.png"
          & $env:NIRCMD_PATH savescreenshot $initialScreenshot
          Write-Host "Initial screenshot taken: $initialScreenshot"
          
          # Start screenshot process in background
          $screenshotJob = Start-Process -FilePath "powershell.exe" -ArgumentList "-ExecutionPolicy Bypass -File `"$env:SCREENSHOT_SCRIPT`" -NircmdPath `"$env:NIRCMD_PATH`" -ScreenshotDir `"$env:SCREENSHOT_DIR`" -IntervalSeconds 30" -PassThru -WindowStyle Hidden
          echo "SCREENSHOT_PID=$($screenshotJob.Id)" >> $env:GITHUB_ENV
          Write-Host "Screenshot process started with PID: $($screenshotJob.Id)"

      - name: Keep workflow running for 6 hours
        shell: powershell
        run: |
          Write-Host "=== Parsec AutoHotkey Automation ==="
          Write-Host "AutoHotkey script is running"
          Write-Host "Screenshots being taken every 30 seconds"
          Write-Host "Screenshots saved to: $env:SCREENSHOT_DIR"
          Write-Host "Parsec should be installed and configured"
          Write-Host "Workflow will run for 6 hours or until manually cancelled"
          Write-Host "====================================="
          
          $startTime = Get-Date
          while ((New-TimeSpan -Start $startTime -End (Get-Date)).TotalHours -lt 6) {
              $elapsed = (New-TimeSpan -Start $startTime -End (Get-Date))
              $screenshotCount = (Get-ChildItem -Path $env:SCREENSHOT_DIR -Filter "*.png" -ErrorAction SilentlyContinue | Measure-Object).Count
              Write-Host "[$(Get-Date)] Running for $($elapsed.ToString('hh\:mm\:ss')) - Screenshots taken: $screenshotCount"
              Start-Sleep -Seconds 300  # Status update every 5 minutes
          }
          
          Write-Host "6-hour limit reached, workflow completed"

      - name: Stop screenshot process
        if: always()
        shell: powershell
        run: |
          # Stop the screenshot process if still running
          if ($env:SCREENSHOT_PID) {
              Stop-Process -Id $env:SCREENSHOT_PID -Force -ErrorAction SilentlyContinue
              Write-Host "Screenshot process stopped"
          }

      - name: List files for debugging
        if: always()
        shell: powershell
        run: |
          Write-Host "Current directory: $(Get-Location)"
          Write-Host ""
          Write-Host "Contents of work directory:"
          Get-ChildItem -Path $env:WORK_DIR -Recurse -ErrorAction SilentlyContinue | Format-Table Name, Length, LastWriteTime
          Write-Host ""
          Write-Host "Contents of screenshot directory:"
          $screenshots = Get-ChildItem -Path $env:SCREENSHOT_DIR -Filter "*.png" -ErrorAction SilentlyContinue
          Write-Host "Total screenshots: $($screenshots.Count)"
          $screenshots | Select-Object -First 10 | Format-Table Name, Length, LastWriteTime
          if ($screenshots.Count -gt 10) {
              Write-Host "... and $($screenshots.Count - 10) more screenshots"
          }

      - name: Upload screenshots as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: parsec-screenshots-${{ github.run_id }}
          path: ${{ env.SCREENSHOT_DIR }}
          retention-days: 7
          if-no-files-found: warn
