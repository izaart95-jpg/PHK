name: Parsec AutoHotkey Automation

on:
  workflow_dispatch:

jobs:
  parsec-ahk-automation:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Create working directory
        shell: powershell
        run: |
          $workDir = "$env:GITHUB_WORKSPACE\parsec-automation"
          $screenshotDir = "$env:GITHUB_WORKSPACE\screenshots"
          New-Item -ItemType Directory -Path $workDir -Force
          New-Item -ItemType Directory -Path $screenshotDir -Force
          Set-Location $workDir
          echo "WORK_DIR=$workDir" >> $env:GITHUB_ENV
          echo "SCREENSHOT_DIR=$screenshotDir" >> $env:GITHUB_ENV

      - name: Download and install NirCmd
        shell: powershell
        run: |
          $nircmdUrl = "https://www.nirsoft.net/utils/nircmd-x64.zip"
          $nircmdZip = "$env:WORK_DIR\nircmd.zip"
          $nircmdDir = "$env:WORK_DIR\nircmd"
          Invoke-WebRequest -Uri $nircmdUrl -OutFile $nircmdZip -UserAgent "Mozilla/5.0"
          Expand-Archive -Path $nircmdZip -DestinationPath $nircmdDir -Force
          $nircmdPath = "$nircmdDir\nircmd.exe"
          echo "NIRCMD_PATH=$nircmdPath" >> $env:GITHUB_ENV
          Write-Host "NirCmd installed at: $nircmdPath"

      - name: Download and install AutoHotkey v2 (Official)
        shell: powershell
        run: |
          # Download from official AutoHotkey GitHub releases
          $ahkUrl = "https://github.com/AutoHotkey/AutoHotkey/releases/download/v2.0.19/AutoHotkey_2.0.19_setup.exe"
          $ahkPath = "$env:WORK_DIR\AutoHotkey_Setup.exe"
          
          Write-Host "Downloading AutoHotkey from official source..."
          Invoke-WebRequest -Uri $ahkUrl -OutFile $ahkPath -UseBasicParsing
          
          # Verify file is valid
          $fileInfo = Get-Item $ahkPath
          Write-Host "Downloaded file size: $($fileInfo.Length) bytes"
          
          if ($fileInfo.Length -lt 1000000) {
              Write-Host "ERROR: File too small, download may have failed"
              exit 1
          }
          
          # Install silently
          Write-Host "Installing AutoHotkey..."
          Start-Process -FilePath $ahkPath -ArgumentList "/silent" -Wait
          
          Write-Host "AutoHotkey installed successfully"

      - name: Download AutoHotkey script
        shell: powershell
        run: |
          $scriptUrl = "https://download1324.mediafire.com/wl4maomsy7zgrw7Zb3L_XP0WSGurFboLAPv9RJV3Zg0V6XDqMoo9wAKPaFE9aDMjTNLtL72qPxB5OSuXSEUZbALIThPG0hNpWiMcCzylNZAUjR9f_WCv_rguJ9Ei-wnd9LxvDa_IP8OjZY5AEv94FJYz-lyUA6amzFeVouLoi80-naQ/dia57ollssbenug/scri%27%2B%27pt.ahk"
          $scriptPath = "$env:WORK_DIR\script.ahk"
          Invoke-WebRequest -Uri $scriptUrl -OutFile $scriptPath
          echo "AHK_SCRIPT_PATH=$scriptPath" >> $env:GITHUB_ENV
          Write-Host "Downloaded AHK script to: $scriptPath"
          
          # Show script content for debugging
          Write-Host "Script content:"
          Get-Content $scriptPath -ErrorAction SilentlyContinue | Select-Object -First 20

      - name: Download and install Parsec
        shell: powershell
        run: |
          $parsecUrl = "https://builds.parsec.app/package/parsec-windows.exe"
          $parsecPath = "$env:WORK_DIR\parsec-windows.exe"
          Invoke-WebRequest -Uri $parsecUrl -OutFile $parsecPath
          Start-Process -FilePath $parsecPath -ArgumentList "/S" -Wait
          Start-Sleep -Seconds 20
          echo "Parsec installed"

      - name: Run AHK then take screenshots for 1 minute
        shell: powershell
        run: |
          $ahkUX = "C:\Program Files\AutoHotkey\UX\AutoHotkeyUX.exe"
          $ahkV2 = "C:\Program Files\AutoHotkey\v2\AutoHotkey.exe"
          $ahk32 = "C:\Program Files\AutoHotkey\v2\AutoHotkey32.exe"
          $ahk64 = "C:\Program Files\AutoHotkey\v2\AutoHotkey64.exe"
          
          # Start Parsec
          Start-Process "parsec:" -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 5
          
          # Find and start AutoHotkey
          $ahkExe = $null
          if (Test-Path $ahkUX) { $ahkExe = $ahkUX }
          elseif (Test-Path $ahkV2) { $ahkExe = $ahkV2 }
          elseif (Test-Path $ahk64) { $ahkExe = $ahk64 }
          elseif (Test-Path $ahk32) { $ahkExe = $ahk32 }
          
          if ($ahkExe) {
              Write-Host "Using AutoHotkey: $ahkExe"
              Start-Process -FilePath $ahkExe -ArgumentList "`"$env:AHK_SCRIPT_PATH`""
              Write-Host "AHK script started"
          }
          else {
              Write-Host "AutoHotkey NOT FOUND! Listing Program Files:"
              Get-ChildItem "C:\Program Files\AutoHotkey" -Recurse -ErrorAction SilentlyContinue
          }
          
          Write-Host "=== TAKING SCREENSHOTS FOR 1 MINUTE ==="
          
          $startTime = Get-Date
          $count = 0
          
          while ((New-TimeSpan -Start $startTime -End (Get-Date)).TotalSeconds -lt 60) {
              $timestamp = Get-Date -Format "yyyy-MM-dd_HH-mm-ss-fff"
              $filename = "$env:SCREENSHOT_DIR\ss_$($count.ToString('D3'))_$timestamp.png"
              
              & $env:NIRCMD_PATH savescreenshot $filename
              Write-Host "[$count] Screenshot: $filename"
              $count++
              
              Start-Sleep -Seconds 5
          }
          
          Write-Host "=== DONE - $count screenshots taken ==="

      - name: Keep alive for 6 hours
        shell: powershell
        run: |
          Write-Host "=== KEEPING WORKFLOW ALIVE ==="
          Write-Host "Parsec and AHK running in background"
          Write-Host "==============================="
          
          $startTime = Get-Date
          while ((New-TimeSpan -Start $startTime -End (Get-Date)).TotalHours -lt 6) {
              Write-Host "[$(Get-Date)] Still alive..."
              Start-Sleep -Seconds 600
          }

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ github.run_id }}
          path: ${{ env.SCREENSHOT_DIR }}
          retention-days: 7
          if-no-files-found: warn
